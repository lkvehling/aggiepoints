<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aggie Points — Leaderboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ aggieBlue:"#022851", aggieGold:"#FFBF00", aggieBg:"#F7F7F7", ink:"#333333" },
          fontFamily:{
            heading:["Raleway","Helvetica Neue","Arial","sans-serif"],
            ui:["Montserrat","Helvetica Neue","Arial","sans-serif"],
            body:["Montserrat","Helvetica Neue","Arial","sans-serif"],
          },
          boxShadow:{ soft:"0 6px 24px rgba(2,40,81,0.08)" }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .15s ease,box-shadow .15s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(2,40,81,.12)}
    .tbl thead th{letter-spacing:.02em}
  </style>
</head>
<body class="min-h-screen bg-aggieBg text-ink font-body">

  <!-- Header -->
  <header class="bg-aggieBlue text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex justify-between items-center py-3">
      <a href="index.html" class="font-ui text-xl font-semibold tracking-wide">Aggie Points</a>
      <nav class="hidden md:flex gap-8 font-ui">
        <a href="index.html" class="hover:text-aggieGold">Home</a>
        <a href="leaderboard.html" class="hover:text-aggieGold">Leaderboard</a>
        <a href="events.html" class="hover:text-aggieGold">All Events</a>
        <a href="about.html" class="hover:text-aggieGold">About</a>
      </nav>
    </div>
  </header>

  <!-- Banner -->
  <section class="bg-gradient-to-r from-aggieBlue to-[#0a3b7b] text-white py-8">
    <div class="mx-auto max-w-7xl px-4">
      <h1 class="font-heading text-3xl sm:text-4xl font-extrabold">Leaderboard</h1>
      <p class="font-ui text-white/90 mt-1">See top individuals and teams.</p>
    </div>
  </section>

  <!-- Main Content -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Sidebar -->
    <aside class="space-y-6 lg:col-span-1">
      <section class="card bg-white rounded-2xl shadow-soft border border-aggieBlue/10 p-4">
        <h2 class="font-ui text-lg font-semibold text-aggieBlue mb-3">Your Summary</h2>
        <div class="space-y-3">
          <div>
            <div class="font-ui text-xs uppercase tracking-wide text-ink/60">Total Points</div>
            <div id="pointsTotal" class="mt-1 text-3xl font-heading font-extrabold text-aggieBlue">—</div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="font-ui text-xs uppercase tracking-wide text-ink/60">Individual Rank</div>
              <div class="mt-1 text-3xl font-heading font-extrabold text-aggieBlue"><span id="individualRank">—</span></div>
            </div>
            <div>
              <div class="font-ui text-xs uppercase tracking-wide text-ink/60">Team Rank</div>
              <div class="mt-1 text-3xl font-heading font-extrabold text-aggieBlue"><span id="teamRank">—</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Search -->
      <section class="card rounded-2xl bg-white shadow-soft p-5 sm:p-6">
        <h3 class="font-ui text-base font-semibold text-aggieBlue">Search Individuals</h3>
        <div class="mt-3 flex items-center gap-2">
          <input id="searchInput" type="search" placeholder="Search by name or team…" class="w-full rounded-xl border border-aggieBlue/10 px-4 py-2 font-ui focus:outline-none focus:ring-2 focus:ring-aggieGold/60" />
          <button id="clearSearch" class="px-3 py-2 rounded-lg font-ui border border-aggieBlue/10 hover:bg-aggieBlue/5">Clear</button>
        </div>
      </section>
    </aside>

    <!-- Leaderboards -->
    <section class="lg:col-span-2 space-y-6">

      <!-- Individuals -->
      <div class="card rounded-2xl bg-white shadow-soft p-5 sm:p-6">
        <div class="flex items-center justify-between">
          <h3 class="font-ui text-lg font-semibold text-aggieBlue">Individuals</h3>
          <span id="indCount" class="font-ui text-sm text-ink/60"></span>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="tbl min-w-full">
            <thead>
              <tr class="text-left border-b border-gray-200">
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Rank</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Name</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Team</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Points</th>
              </tr>
            </thead>
            <tbody id="indBody" class="divide-y divide-gray-100"></tbody>
          </table>
          <div id="indEmpty" class="hidden py-8 text-center font-ui text-ink/60">No individuals found.</div>
          <div class="mt-3 flex justify-center gap-3">
            <button id="indToggleBtn" class="px-4 py-2 rounded-lg border border-aggieBlue/20 font-ui hover:bg-aggieBlue/5">See all</button>
          </div>
        </div>
      </div>

      <!-- Teams -->
      <div class="card rounded-2xl bg-white shadow-soft p-5 sm:p-6">
        <div class="flex items-center justify-between">
          <h3 class="font-ui text-lg font-semibold text-aggieBlue">Teams</h3>
          <span id="teamCount" class="font-ui text-sm text-ink/60"></span>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="tbl min-w-full">
            <thead>
              <tr class="text-left border-b border-gray-200">
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Rank</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Team</th>
              </tr>
            </thead>
            <tbody id="teamBody" class="divide-y divide-gray-100"></tbody>
          </table>
          <div id="teamEmpty" class="hidden py-8 text-center font-ui text-ink/60">No teams found.</div>
          <div class="mt-3 flex justify-center gap-3">
            <button id="teamToggleBtn" class="px-4 py-2 rounded-lg border border-aggieBlue/20 font-ui hover:bg-aggieBlue/5">See all</button>
          </div>
        </div>
      </div>

    </section>
  </main>

  <footer class="border-t border-gray-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-sm font-ui text-ink/60">
      © <span id="year"></span> Aggie Points.
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>
  <script>
    const $ = s=>document.querySelector(s);
    const esc = s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    $("#year").textContent = new Date().getFullYear();

    let showAllIndividuals = false;
    let showAllTeams = false;
    let INDIVIDUALS=[], TEAMS=[];

    function computeRankLabelsByValue(vals){
      const labels=[],n=vals.length;let rank=1;
      for(let i=0;i<n;){let j=i+1;while(j<n&&vals[j]===vals[i])j++;
        const lbl=j-i>1?`T${rank}`:`${rank}`;
        for(let k=i;k<j;k++)labels[k]=lbl;rank+=j-i;i=j;}
      return labels;
    }

    async function loadIndividuals(){
      const limit = showAllIndividuals ? null : 10;
      const {data,error} = await sb.rpc("leaderboard_top_individuals", {limit_n: limit});
      if(error){console.warn(error);return;}
      INDIVIDUALS = data || [];
      renderIndividuals();
      $("#indCount").textContent = showAllIndividuals ? `${INDIVIDUALS.length} total` : "Top 10";
      $("#indToggleBtn").textContent = showAllIndividuals ? "See top 10" : "See all";
    }

    function renderIndividuals(){
      const body=$("#indBody"),empty=$("#indEmpty");
      body.innerHTML="";
      if(!INDIVIDUALS.length){empty.classList.remove("hidden");return;}
      empty.classList.add("hidden");
      const pts=INDIVIDUALS.map(r=>r.points??0),ranks=computeRankLabelsByValue(pts);
      INDIVIDUALS.forEach((r,i)=>{
        body.insertAdjacentHTML("beforeend",`
          <tr class="hover:bg-aggieBlue/5">
            <td class="py-3 px-4 font-ui">${ranks[i]}</td>
            <td class="py-3 px-4 font-ui">${esc(r.name)}</td>
            <td class="py-3 px-4 font-ui">${esc(r.team)}</td>
            <td class="py-3 px-4 font-ui font-semibold text-aggieBlue">${r.points}</td>
          </tr>`);
      });
    }

    async function loadTeams(){
      const { start, end } = monthRangeISO();
      const limit = showAllTeams ? null : 5;
      const {data,error} = await sb.rpc("team_score_participation_weighted", {
        month_start: start, month_end: end, limit_n: limit
      });
      if(error){console.warn(error);return;}
      TEAMS = data || [];
      renderTeams();
      $("#teamCount").textContent = showAllTeams ? `${TEAMS.length} total` : "Top 5";
      $("#teamToggleBtn").textContent = showAllTeams ? "See top 5" : "See all";
    }

    function renderTeams(){
      const body=$("#teamBody"),empty=$("#teamEmpty");
      body.innerHTML="";
      if(!TEAMS.length){empty.classList.remove("hidden");return;}
      empty.classList.add("hidden");
      const vals=TEAMS.map(r=>r.score??0),ranks=computeRankLabelsByValue(vals);
      TEAMS.forEach((r,i)=>{
        body.insertAdjacentHTML("beforeend",`
          <tr class="hover:bg-aggieBlue/5">
            <td class="py-3 px-4 font-ui">${ranks[i]}</td>
            <td class="py-3 px-4 font-ui font-semibold text-aggieBlue">${esc(r.team)}</td>
          </tr>`);
      });
    }

    function monthRangeISO(d=new Date()){
      const start=new Date(d.getFullYear(),d.getMonth(),1);
      const end=new Date(d.getFullYear(),d.getMonth()+1,1);
      return {start:start.toISOString(), end:end.toISOString()};
    }

    $("#indToggleBtn").addEventListener("click",async()=>{
      showAllIndividuals=!showAllIndividuals;
      await loadIndividuals();
    });

    $("#teamToggleBtn").addEventListener("click",async()=>{
      showAllTeams=!showAllTeams;
      await loadTeams();
    });

    (async()=>{
      await loadIndividuals();
      await loadTeams();
    })();
  </script>
</body>
</html>
