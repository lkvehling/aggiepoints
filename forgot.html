<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Forgot Password — Aggie Points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts + Tailwind theme -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ aggieBlue:"#022851", aggieGold:"#FFBF00", aggieBg:"#F7F7F7", ink:"#333333" },
          fontFamily:{
            heading:["Raleway","Helvetica Neue","Arial","sans-serif"],
            ui:["Montserrat","Helvetica Neue","Arial","sans-serif"],
            body:["Merriweather","Georgia","serif"],
          },
          boxShadow:{ soft:"0 6px 24px rgba(2,40,81,0.08)" }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 30px rgba(2,40,81,.12)}
  </style>
</head>
<body class="min-h-screen bg-aggieBg text-ink font-body">
  <!-- Simple header to stay on-brand -->
  <header class="bg-aggieBlue text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-3">
        <a href="index.html" class="font-ui text-xl font-semibold tracking-wide">Aggie Points</a>
        <a href="login.html" class="font-ui hover:text-aggieGold">Back to login</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="mx-auto w-full max-w-md card bg-white rounded-2xl shadow-soft border border-aggieBlue/10">
      <div class="p-6">
        <h1 class="font-heading text-2xl font-extrabold text-aggieBlue mb-2">Reset your password</h1>
        <p class="font-ui text-sm text-ink/70 mb-4">Enter your email and we’ll send a reset link.</p>

        <label class="block mb-4">
          <span class="font-ui text-sm uppercase tracking-wide text-ink/60">UC Davis email</span>
          <input
            id="email"
            type="email"
            inputmode="email"
            autocomplete="email"
            required
            pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
            class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 font-ui focus:outline-none focus:ring-2 focus:ring-aggieBlue"
            placeholder="you@ucdavis.edu"
          />

        </label>

        <button
          id="sendBtn"
          class="w-full inline-flex items-center justify-center rounded-lg bg-aggieBlue px-4 py-2 font-ui font-semibold text-white hover:bg-aggieBlue/90">
          Send reset link
        </button>

        <p id="msg" class="font-ui text-sm mt-3" role="status" aria-live="polite"></p>
      </div>
    </div>
  </main>

  <footer class="border-t border-gray-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-sm font-ui text-ink/60">
      © <span id="yearText"></span> Aggie Points.
    </div>
  </footer>

  <!-- Supabase + your config (reuses global `sb`) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>
  <script>
    document.getElementById('yearText').textContent = new Date().getFullYear();

    const emailEl = document.getElementById('email');
    const msgEl   = document.getElementById('msg');
    const btn     = document.getElementById('sendBtn');

    // Simple, safe email check (avoids whitespace/hidden chars issues)
    const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function setMsg(txt, ok=false){
      msgEl.textContent = txt;
      msgEl.className = "font-ui text-sm mt-3 " + (ok ? "text-green-700" : "text-aggieBlue");
    }
    function setBusy(v){
      btn.disabled = !!v;
      btn.classList.toggle('opacity-60', !!v);
    }

    // Build an absolute redirect URL robustly: <origin>/<dir>/reset.html
    function buildRedirectTo(){
      const base = location.origin + location.pathname.replace(/[^/]+$/, '');
      return base + 'reset.html';
    }

    async function sendReset(){
      // Normalize email: trim, collapse spaces, lowercase domain
      let email = (emailEl.value || "")
        .trim()
        .replace(/\s+/g, " ")   // collapse accidental spaces/newlines
        .toLowerCase();

      const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!EMAIL_RE.test(email)) {
        setMsg("Please enter a valid email (e.g., you@ucdavis.edu).");
        emailEl.focus();
        return;
      }

      setBusy(true);
      try {
        const redirectTo = buildRedirectTo(); // must be allowlisted in Supabase Auth → URL Configuration
        const { data, error } = await sb.auth.resetPasswordForEmail(email, {
          redirectTo: "https://lkvehling.github.io/aggiepoints/reset.html",
        });
        console.log({ data, error });


        if (error) {
          // Show exact error to diagnose e.g. "URL not allowed" or "Email address is invalid"
          setMsg(error.message || "Could not send reset email.");
          console.log('resetPasswordForEmail error:', error);
        } else {
          setMsg("Check your email for a password-reset link.", true);
          console.log('resetPasswordForEmail data:', data);
        }
      } catch (e) {
        setMsg("Something went wrong sending the reset. Try again.");
        console.error(e);
      } finally {
        setBusy(false);
      }
    }

    btn.addEventListener('click', sendReset);
    emailEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendReset();
      }
    });
  </script>
</body>
</html>
