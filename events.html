<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aggie Points – All Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --brand:#002855; --border:#e5e7eb; --bg:#f7f7fb; --muted:#6b7280; --card:#fff; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:var(--bg); }
    .topbar { position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; padding:12px 18px; }
    .brand { font-weight:800; color:var(--brand); }
    .nav { margin-left:auto; display:flex; gap:12px; }
    .nav a { text-decoration:none; color:#111; padding:8px 10px; border-radius:8px; }
    .nav a:hover{ background:#eef2ff; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { margin:0 0 12px; }
    h2 { margin:22px 0 8px; }
    h3 { margin:14px 0 6px; color:#111; }
    .section { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:16px; }
    .event { border:1px dashed var(--border); border-radius:12px; padding:10px 12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:10px; background:#fff; }
    .muted { color:var(--muted); }
    .btn { background:var(--brand); color:#fff; border:none; border-radius:10px; padding:8px 12px; text-decoration:none; }
    .tag { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2937; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">AGGIE POINTS</div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="events.html">All Events</a>
      <a href="leaderboard.html">Leaderboard</a>
    </nav>
  </header>

  <main class="wrap">
    <h1>All Events</h1>
    <p class="muted">Plan ahead. Events listed by month and week. <a href="index.html">Go to Today</a> to check in.</p>

    <div id="eventsWrap"></div>
  </main>

  <script src="auth-config.js"></script>
  <script>
    let user = null;
    (async function main() {
      user = await requireSessionOrRedirect();
      if (!user) return;
      await loadUpcoming();
    })();

    function formatPacific(utcIso, opts={}) {
      return new Date(utcIso).toLocaleString("en-US", {
        timeZone: "America/Los_Angeles",
        ...(opts.dateStyle ? {} : { month:"short", day:"numeric" }),
        ...opts
      });
    }

    function pacificDayBoundsUTC(d = new Date()) {
      const tz = "America/Los_Angeles";
      const pac = new Date(d.toLocaleString("en-US", { timeZone: tz }));
      const start = new Date(pac); start.setHours(0,0,0,0);
      const end   = new Date(pac); end.setHours(23,59,59,999);
      return { startUTC: start.toISOString(), endUTC: end.toISOString() };
    }

    function isTodayPacific(isoUtc) {
      const { startUTC, endUTC } = pacificDayBoundsUTC();
      const t = new Date(isoUtc).toISOString();
      return t >= startUTC && t <= endUTC;
    }

    function weekStartPacific(isoUtc) {
      const tz = "America/Los_Angeles";
      const d = new Date(new Date(isoUtc).toLocaleString("en-US", { timeZone: tz }));
      const day = d.getDay(); // 0 Sun..6 Sat
      const mondayOffset = (day + 6) % 7; // make Monday start
      d.setDate(d.getDate() - mondayOffset);
      d.setHours(0,0,0,0);
      return d; // local pacific Date object
    }

    async function loadUpcoming() {
      // pull events from now to ~60 days
      const now = new Date();
      const until = new Date(now); until.setDate(until.getDate() + 60);

      const { data: events, error } = await sb
        .from("events")
        .select("*")
        .gte("start_time_utc", now.toISOString())
        .lt("start_time_utc", until.toISOString())
        .order("start_time_utc", { ascending:true });

      const wrap = document.getElementById("eventsWrap");
      wrap.innerHTML = "";

      if (error) {
        wrap.textContent = "Failed to load events.";
        return;
      }
      if (!events || !events.length) {
        wrap.textContent = "No upcoming events.";
        return;
      }

      // Group by month -> week
      const byMonth = new Map();
      for (const ev of events) {
        const mLabel = new Date(ev.start_time_utc).toLocaleString("en-US", { timeZone:"America/Los_Angeles", month:"long", year:"numeric" });
        if (!byMonth.has(mLabel)) byMonth.set(mLabel, []);
        byMonth.get(mLabel).push(ev);
      }

      for (const [monthLabel, monthEvents] of byMonth.entries()) {
        const sec = document.createElement("section");
        sec.className = "section";
        sec.innerHTML = `<h2>${monthLabel}</h2>`;
        const weeks = new Map();

        for (const ev of monthEvents) {
          const wStart = weekStartPacific(ev.start_time_utc);
          const wLabel = `Week of ${wStart.toLocaleDateString("en-US",{ month:"short", day:"numeric"})}`;
          if (!weeks.has(wLabel)) weeks.set(wLabel, []);
          weeks.get(wLabel).push(ev);
        }

        for (const [weekLabel, weekEvents] of weeks.entries()) {
          const h = document.createElement("h3");
          h.textContent = weekLabel;
          sec.appendChild(h);

          weekEvents.forEach(ev => {
            const today = isTodayPacific(ev.start_time_utc);
            const row = document.createElement("div");
            row.className = "event";
            row.innerHTML = `
              <div>
                <div style="font-weight:700">${ev.name}</div>
                <div class="muted" style="font-size:14px">
                  ${formatPacific(ev.start_time_utc, { dateStyle:"medium", timeStyle:"short" })}
                  &nbsp;–&nbsp;
                  ${formatPacific(ev.end_time_utc,   { dateStyle:"medium", timeStyle:"short" })}
                </div>
                <div class="muted" style="font-size:14px">Location: ${ev.location || "N/A"} • Points: <span class="tag">${ev.points ?? 0}</span></div>
              </div>
              <div>
                ${today
                  ? `<a class="btn" href="index.html" title="Go to Today to check in">Check In</a>`
                  : `<span class="muted">Opens day of event</span>`
                }
              </div>
            `;
            sec.appendChild(row);
          });
        }
        wrap.appendChild(sec);
      }
    }
  </script>
</body>
</html>
