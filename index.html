<!DOCTYPE html>
<html>
<head>
  <title>Aggie Points Check-In</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 40px; }
    #formContainer { display: none; margin-top: 20px; }
    iframe { width: 100%; height: 800px; border: none; }
  </style>
</head>
<body>
  <h2>Aggie Points Check-In</h2>
  <p id="status">Checking your location...</p>
  <div id="formContainer">
    <iframe id="jotformFrame"></iframe>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKTWEbVoSyYdw6wVVbIuql9hb_NoAt7jcLoFfKI2PCz9UA3z8PJwkrWcFDjbEbGj9FVb_R_6r2Y2es/pub?output=csv"; // CSV link

    async function getEventData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim());
      const today = new Date().toISOString().split("T")[0];

      // Temporary: pick first row for testing
      const eventRow = rows[1];
      console.log("Selected event row:", eventRow);

      return {
        name: eventRow[headers.indexOf("Event Name")].trim(),
        latMin: parseFloat(eventRow[headers.indexOf("Lat Min")].trim()),
        latMax: parseFloat(eventRow[headers.indexOf("Lat Max")].trim()),
        lngMin: parseFloat(eventRow[headers.indexOf("Lng Min")].trim()),
        lngMax: parseFloat(eventRow[headers.indexOf("Lng Max")].trim()),
        start: eventRow[headers.indexOf("Start Time")].trim(),
        end: eventRow[headers.indexOf("End Time")].trim()
      };
    }

    function inBox(lat, lng, ev) {
      // Numeric comparison ensures strings from CSV don't break it
      return lat >= ev.latMin && lat <= ev.latMax && lng >= ev.lngMin && lng <= ev.lngMax;
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const now = new Date();

      const event = await getEventData();
      if (!event) {
        document.getElementById("status").innerText = "No event scheduled today.";
        return;
      }

      const start = new Date(event.start);
      const end = new Date(event.end);

      // TEMPORARY: skip time check for testing location
      if (inBox(lat, lng, event)) {
        document.getElementById("status").innerText = `Welcome! Checking you into ${event.name}`;
        const jotf
