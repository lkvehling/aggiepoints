<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggie Points — Leaderboard</title>

  <!-- Fonts (Raleway = headings, Montserrat = UI/body, Merriweather optional body) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aggieBlue: "#022851",
            aggieGold: "#FFBF00",
            aggieBg: "#F7F7F7",
            ink: "#333333",
            inkDim: "#4A4A4A",
            success: "#0E9F6E",
            danger: "#DC2626"
          },
          fontFamily: {
            heading: ["Raleway", "Helvetica Neue", "Arial", "sans-serif"],
            ui: ["Montserrat", "Helvetica Neue", "Arial", "sans-serif"],
            body: ["Montserrat", "Helvetica Neue", "Arial", "sans-serif"],
            serif: ["Merriweather", "Georgia", "serif"],
          },
          boxShadow: {
            soft: "0 8px 30px rgba(2,40,81,0.08)"
          }
        }
      }
    }
  </script>

  <style>
    /* Reduce tap highlights on mobile */
    * { -webkit-tap-highlight-color: transparent; }
    /* Tighten table spacing on small screens */
    @media (max-width: 420px) {
      .td-tight td { padding-top: 0.35rem; padding-bottom: 0.35rem; }
    }
  </style>
</head>
<body class="bg-aggieBg text-ink font-body">

  <!-- Top Bar -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur shadow-sm">
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3 flex items-center gap-3">
      <div class="w-8 h-8 rounded-xl bg-aggieBlue/90 flex items-center justify-center">
        <span class="text-aggieGold font-heading font-extrabold text-lg">AP</span>
      </div>
      <h1 class="font-heading text-lg sm:text-xl text-aggieBlue font-extrabold tracking-wide">Leaderboard</h1>
      <div class="ml-auto flex items-center gap-2">
        <a href="index.html" class="hidden sm:inline-block text-sm text-aggieBlue/80 hover:text-aggieBlue underline-offset-2 hover:underline">Home</a>
        <a href="events.html" class="hidden sm:inline-block text-sm text-aggieBlue/80 hover:text-aggieBlue underline-offset-2 hover:underline">Events</a>
        <a href="settings.html" class="hidden sm:inline-block text-sm text-aggieBlue/80 hover:text-aggieBlue underline-offset-2 hover:underline">Settings</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 sm:px-4 py-4">

    <!-- Filters / Controls -->
    <section class="mb-3">
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
        <!-- Search -->
        <label class="sm:col-span-2">
          <span class="sr-only">Search athletes</span>
          <input id="searchInput" type="text" placeholder="Search athlete or team…" class="w-full rounded-xl border border-aggieBlue/10 bg-white shadow-soft px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-aggieGold" />
        </label>

        <!-- Team Filter -->
        <label class="sm:col-span-2">
          <span class="sr-only">Filter by team</span>
          <select id="teamFilter" class="w-full rounded-xl border border-aggieBlue/10 bg-white shadow-soft px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-aggieGold">
            <option value="">All teams</option>
          </select>
        </label>

        <!-- View toggle -->
        <div class="sm:col-span-1">
          <div class="bg-white border border-aggieBlue/10 rounded-xl shadow-soft p-1 flex">
            <button id="viewAll" class="flex-1 text-xs sm:text-sm px-2 py-1 rounded-lg bg-aggieBlue text-white">All</button>
            <button id="viewParticipation" class="flex-1 text-xs sm:text-sm px-2 py-1 rounded-lg">Participation</button>
            <button id="viewAverage" class="flex-1 text-xs sm:text-sm px-2 py-1 rounded-lg">Average</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Table / List -->
    <section class="bg-white border border-aggieBlue/10 rounded-2xl shadow-soft overflow-hidden">

      <!-- Sticky table header for larger screens -->
      <div class="hidden sm:block overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-aggieBlue/90 text-white sticky top-0 z-10">
            <tr>
              <th class="text-left font-semibold px-3 py-2"># Part</th>
              <th class="text-left font-semibold px-3 py-2">Athlete</th>
              <th class="text-left font-semibold px-3 py-2">Team</th>
              <th class="text-right font-semibold px-3 py-2">Events</th>
              <th class="text-right font-semibold px-3 py-2">Points</th>
              <th class="text-right font-semibold px-3 py-2">Avg / Ev</th>
              <th class="text-right font-semibold px-3 py-2"># Avg</th>
              <th class="text-right font-semibold px-3 py-2">Δ Rank</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-aggieBlue/5 td-tight"></tbody>
        </table>
      </div>

      <!-- Mobile card list -->
      <div id="mobileList" class="sm:hidden divide-y divide-aggieBlue/5"></div>

      <!-- Footer: pagination -->
      <div class="px-3 py-2 flex items-center justify-between bg-aggieBg/60">
        <div class="text-xs text-inkDim" id="countLabel">Showing 0</div>
        <button id="loadMoreBtn" class="text-sm px-3 py-1 rounded-lg border border-aggieBlue/20 hover:border-aggieBlue/40 bg-white hover:bg-aggieBg">Load more</button>
      </div>
    </section>

    <!-- Legend -->
    <p class="mt-2 text-xs text-inkDim">
      Δ Rank = (# Avg) − (# Part). Lower is better. <span class="text-success">▲</span> means better Avg rank than Participation; <span class="text-danger">▼</span> the opposite.
    </p>

  </main>

  <!-- Supabase client config -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>

  <script>
    // ===== Field mapping (adjust here if your column names differ) =====
    const FIELD_MAP = {
      id: "id",
      name: "full_name",
      team: "team_name",
      total_points: "total_points",
      events_attended: "events_attended",
      avg_points: "avg_points_per_event", // if missing, computed as total_points / events_attended
    };

    // ===== Paging / State =====
    const PAGE_SIZE = 50;          // small to limit scrolling
    let allAthletes = [];          // raw fetched + computed ranks
    let filtered = [];             // filtered by search/team
    let renderedCount = 0;         // how many rows rendered
    let currentView = "all";       // 'all' | 'participation' | 'average'

    // ===== UI Elements =====
    const searchInput = document.getElementById('searchInput');
    const teamFilter = document.getElementById('teamFilter');
    const viewAllBtn = document.getElementById('viewAll');
    const viewPartBtn = document.getElementById('viewParticipation');
    const viewAvgBtn = document.getElementById('viewAverage');
    const tableBody = document.getElementById('tableBody');
    const mobileList = document.getElementById('mobileList');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const countLabel = document.getElementById('countLabel');

    // ===== Helpers =====
    function toFixed1(x) {
      return (x ?? 0).toFixed(1);
    }
    function computeRanks(items, key, tiebreakers = []) {
      // sort descending by key; lower rank is better (1 = best)
      const arr = [...items].sort((a, b) => {
        const d = (b[key] ?? 0) - (a[key] ?? 0);
        if (d !== 0) return d;
        for (const tb of tiebreakers) {
          const dd = (b[tb] ?? 0) - (a[tb] ?? 0);
          if (dd !== 0) return dd;
        }
        return a.name.localeCompare(b.name);
      });
      const rankMap = new Map();
      let rank = 1;
      for (let i = 0; i < arr.length; i++) {
        // handle ties: if value equals previous, keep same rank
        if (i > 0) {
          const prev = arr[i - 1], cur = arr[i];
          if ((cur[key] ?? 0) !== (prev[key] ?? 0)) rank = i + 1;
        }
        rankMap.set(arr[i].id, rank);
      }
      return rankMap;
    }
    function arrowForDelta(delta) {
      if (delta < 0) return `<span class="text-success font-bold">▲ ${Math.abs(delta)}</span>`;
      if (delta > 0) return `<span class="text-danger font-bold">▼ ${Math.abs(delta)}</span>`;
      return `<span class="text-inkDim">—</span>`;
    }
    function clearRender() {
      tableBody.innerHTML = "";
      mobileList.innerHTML = "";
      renderedCount = 0;
    }
    function applyFiltersAndView() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const team = teamFilter.value || "";

      filtered = allAthletes.filter(a => {
        const matchQ = !q || (a.name?.toLowerCase().includes(q) || a.team?.toLowerCase().includes(q));
        const matchT = !team || a.team === team;
        return matchQ && matchT;
      });

      // Select sort order based on view
      if (currentView === "participation") {
        filtered.sort((a, b) =>
          (a.rank_participation - b.rank_participation) || (a.rank_average - b.rank_average)
        );
      } else if (currentView === "average") {
        filtered.sort((a, b) =>
          (a.rank_average - b.rank_average) || (a.rank_participation - b.rank_participation)
        );
      } else {
        // 'all': default by participation rank (feels most fair)
        filtered.sort((a, b) =>
          (a.rank_participation - b.rank_participation) || (a.rank_average - b.rank_average)
        );
      }

      clearRender();
      renderMore();
      updateCount();
    }
    function updateCount() {
      countLabel.textContent = `Showing ${Math.min(renderedCount, filtered.length)} of ${filtered.length}`;
      loadMoreBtn.style.display = renderedCount < filtered.length ? "inline-block" : "none";
    }
    function renderRow(a) {
      // Desktop row
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2 text-inkDim">${a.rank_participation}</td>
        <td class="px-3 py-2 font-semibold text-ink">${a.name || "—"}</td>
        <td class="px-3 py-2 text-inkDim">${a.team || "—"}</td>
        <td class="px-3 py-2 text-right">${a.events_attended ?? 0}</td>
        <td class="px-3 py-2 text-right">${a.total_points ?? 0}</td>
        <td class="px-3 py-2 text-right">${toFixed1(a.avg_points)}</td>
        <td class="px-3 py-2 text-right">${a.rank_average}</td>
        <td class="px-3 py-2 text-right">${arrowForDelta(a.delta_rank)}</td>
      `;
      tableBody.appendChild(tr);

      // Mobile card
      const card = document.createElement('div');
      card.className = "px-3 py-2";
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="min-w-0">
            <div class="text-xs text-inkDim"># Part ${a.rank_participation} • # Avg ${a.rank_average}</div>
            <div class="font-semibold truncate">${a.name || "—"}</div>
            <div class="text-xs text-inkDim truncate">${a.team || "—"}</div>
          </div>
          <div class="text-right ml-3">
            <div class="text-xs">${arrowForDelta(a.delta_rank)}</div>
            <div class="text-[11px] text-inkDim">Δ Rank</div>
          </div>
        </div>
        <div class="mt-1 grid grid-cols-3 gap-1 text-sm">
          <div class="bg-aggieBg rounded-lg px-2 py-1 text-center">
            <div class="font-semibold">${a.events_attended ?? 0}</div>
            <div class="text-[11px] text-inkDim">Events</div>
          </div>
          <div class="bg-aggieBg rounded-lg px-2 py-1 text-center">
            <div class="font-semibold">${a.total_points ?? 0}</div>
            <div class="text-[11px] text-inkDim">Points</div>
          </div>
          <div class="bg-aggieBg rounded-lg px-2 py-1 text-center">
            <div class="font-semibold">${toFixed1(a.avg_points)}</div>
            <div class="text-[11px] text-inkDim">Avg/Ev</div>
          </div>
        </div>
      `;
      mobileList.appendChild(card);
    }
    function renderMore() {
      const next = filtered.slice(renderedCount, renderedCount + PAGE_SIZE);
      next.forEach(renderRow);
      renderedCount += next.length;
      updateCount();
    }

    function setView(newView) {
      currentView = newView;
      // button styles
      for (const btn of [viewAllBtn, viewPartBtn, viewAvgBtn]) {
        btn.classList.remove("bg-aggieBlue", "text-white");
      }
      if (newView === "all") viewAllBtn.classList.add("bg-aggieBlue","text-white");
      if (newView === "participation") viewPartBtn.classList.add("bg-aggieBlue","text-white");
      if (newView === "average") viewAvgBtn.classList.add("bg-aggieBlue","text-white");
      applyFiltersAndView();
    }

    // ===== Fetch & Prepare =====
    async function fetchLeaderboard() {
      // Pull only what we need for speed
      const fields = [
        FIELD_MAP.id,
        FIELD_MAP.name,
        FIELD_MAP.team,
        FIELD_MAP.total_points,
        FIELD_MAP.events_attended,
        FIELD_MAP.avg_points
      ].filter(Boolean).join(",");

      const { data, error } = await sb
        .from('profiles')
        .select(fields)
        .neq(FIELD_MAP.name, null);

      if (error) {
        console.error(error);
        alert("Failed to load leaderboard.");
        return;
      }

      // Normalize & compute missing fields
      const rows = (data || []).map(r => {
        const id = r[FIELD_MAP.id];
        const name = r[FIELD_MAP.name];
        const team = r[FIELD_MAP.team] ?? "";
        const total_points = Number(r[FIELD_MAP.total_points] ?? 0);
        const events_attended = Number(r[FIELD_MAP.events_attended] ?? 0);
        const avg_points = r[FIELD_MAP.avg_points] != null
          ? Number(r[FIELD_MAP.avg_points])
          : (events_attended > 0 ? total_points / events_attended : 0);

        return { id, name, team, total_points, events_attended, avg_points };
      });

      // Compute ranks
      const partRanks = computeRanks(rows, "events_attended", ["total_points"]);
      const avgRanks  = computeRanks(rows, "avg_points", ["total_points", "events_attended"]);

      allAthletes = rows.map(a => {
        const rank_participation = partRanks.get(a.id) ?? 9999;
        const rank_average = avgRanks.get(a.id) ?? 9999;
        const delta_rank = rank_average - rank_participation; // lower is better
        return { ...a, rank_participation, rank_average, delta_rank };
      });

      // Fill team filter
      const teams = Array.from(new Set(allAthletes.map(a => a.team).filter(Boolean))).sort();
      for (const t of teams) {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        teamFilter.appendChild(opt);
      }

      applyFiltersAndView();
    }

    // ===== Events =====
    searchInput.addEventListener('input', () => applyFiltersAndView());
    teamFilter.addEventListener('change', () => applyFiltersAndView());
    loadMoreBtn.addEventListener('click', () => renderMore());
    viewAllBtn.addEventListener('click', () => setView('all'));
    viewPartBtn.addEventListener('click', () => setView('participation'));
    viewAvgBtn.addEventListener('click', () => setView('average'));

    // ===== Kickoff =====
    fetchLeaderboard();
  </script>
</body>
</html>
