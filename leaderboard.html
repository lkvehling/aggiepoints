<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aggie Points — Leaderboard</title>

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ aggieBlue:"#022851", aggieGold:"#FFBF00", aggieBg:"#F7F7F7", ink:"#333333" },
          fontFamily:{
            heading:["Raleway","Helvetica Neue","Arial","sans-serif"],
            ui:["Montserrat","Helvetica Neue","Arial","sans-serif"],
            body:["Montserrat","Helvetica Neue","Arial","sans-serif"],
          },
          boxShadow:{ soft:"0 6px 24px rgba(2,40,81,0.08)" }
        }
      }
    }
  </script>
  <style>
    .card{transition:transform .15s ease,box-shadow .15s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(2,40,81,.12)}
    .tbl thead th{letter-spacing:.02em}
  </style>
</head>
<body class="min-h-screen bg-aggieBg text-ink font-body">

  <!-- Header -->
  <header class="bg-aggieBlue text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex justify-between items-center py-3">
      <a href="index.html" class="font-ui text-xl font-semibold tracking-wide">Aggie Points</a>
      <nav class="hidden md:flex gap-8 font-ui items-center">
        <a href="index.html" class="hover:text-aggieGold">Home</a>
        <a href="leaderboard.html" class="hover:text-aggieGold">Leaderboard</a>
        <a href="events.html" class="hover:text-aggieGold">All Events</a>
        <a href="about.html" class="hover:text-aggieGold">About</a>
        <!-- Account dropdown -->
          <div class="relative">
            <button id="acctBtn" class="hover:text-aggieGold flex items-center gap-2">
              <span id="acctName" class="font-medium">Account</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <div id="acctMenu" class="absolute right-0 mt-2 w-44 bg-white text-ink rounded-lg shadow-soft py-2 hidden">
              <a href="settings.html" class="block px-4 py-2 hover:bg-gray-100">Settings</a>
              <button id="logoutBtn" class="w-full text-left block px-4 py-2 hover:bg-gray-100">Log out</button>
            </div>
          </div>
      </nav>
    </div>
  </header>

  <!-- Banner -->
  <section class="bg-gradient-to-r from-aggieBlue to-[#0a3b7b] text-white py-8">
    <div class="mx-auto max-w-7xl px-4">
      <h1 class="font-heading text-3xl sm:text-4xl font-extrabold">Leaderboard</h1>
      <p class="font-ui text-white/90 mt-1">See top individuals and teams.</p>
    </div>
  </section>

  <!-- Main Content -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Sidebar -->
    <aside class="space-y-6 lg:col-span-1">
      <section class="card bg-white rounded-2xl shadow-soft border border-aggieBlue/10 p-4">
        <h2 class="font-ui text-lg font-semibold text-aggieBlue mb-3">Your Summary</h2>
        <div class="space-y-3">
          <div>
            <div class="font-ui text-xs uppercase tracking-wide text-ink/60">Total Points</div>
            <div id="pointsTotal" class="mt-1 text-3xl font-heading font-extrabold text-aggieBlue">—</div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="font-ui text-xs uppercase tracking-wide text-ink/60">Individual Rank</div>
              <div class="mt-1 text-3xl font-heading font-extrabold text-aggieBlue"><span id="individualRank">—</span></div>
            </div>
            <div>
              <div class="font-ui text-xs uppercase tracking-wide text-ink/60">Team Rank</div>
              <div class="mt-1 text-3xl font-heading font-extrabold text-aggieBlue"><span id="teamRank">—</span></div>
            </div>
          </div>
          <div class="mt-5 flex gap-3">
            <a href="index.html" class="px-4 py-2 rounded-lg bg-aggieBlue text-white font-ui hover:bg-aggieBlue/90">Check In</a>
            <a href="events.html" class="px-4 py-2 rounded-lg bg-aggieGold text-aggieBlue font-ui hover:brightness-95">All Events</a>
          </div>
        </div>
      </section>

      <!-- Search Individuals -->
      <section class="card rounded-2xl bg-white shadow-soft p-5 sm:p-6">
        <h3 class="font-ui text-base font-semibold text-aggieBlue">Search Individuals</h3>
        <div class="mt-3 flex items-center gap-2">
          <input id="searchInput" type="search" placeholder="Search by name or team…" class="w-full rounded-xl border border-aggieBlue/10 px-4 py-2 font-ui focus:outline-none focus:ring-2 focus:ring-aggieGold/60" />
          <button id="clearSearch" class="px-3 py-2 rounded-lg font-ui border border-aggieBlue/10 hover:bg-aggieBlue/5">Clear</button>
        </div>
      </section>
    </aside>

    <!-- Leaderboards -->
    <section class="lg:col-span-2 space-y-6">

      <!-- Individuals -->
      <div class="card rounded-2xl bg-white shadow-soft p-5 sm:p-6">
        <div class="flex items-center justify-between">
          <h3 class="font-ui text-lg font-semibold text-aggieBlue">Individuals</h3>
          <span id="indCount" class="font-ui text-sm text-ink/60"></span>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="tbl min-w-full">
            <thead>
              <tr class="text-left border-b border-gray-200">
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Rank</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Name</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Team</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Points</th>
              </tr>
            </thead>
            <tbody id="indBody" class="divide-y divide-gray-100"></tbody>
          </table>
          <div id="indEmpty" class="hidden py-8 text-center font-ui text-ink/60">No individuals found.</div>
          <div class="mt-3 flex justify-center">
            <button id="indToggleBtn" class="px-4 py-2 rounded-lg border border-aggieBlue/20 font-ui hover:bg-aggieBlue/5">See all</button>
          </div>
        </div>
      </div>

      <!-- Teams (Avg-based ranking; no roster display) -->
      <div class="card rounded-2xl bg-white shadow-soft p-5 sm:p-6">
        <div class="flex items-center justify-between">
          <h3 class="font-ui text-lg font-semibold text-aggieBlue">Teams</h3>
          <span id="teamCount" class="font-ui text-sm text-ink/60"></span>
        </div>

        <p class="mt-2 text-xs md:text-sm text-ink/70">
          Ranked by <span class="font-semibold">Average Points per Team Member</span>.
        </p>

        <div class="mt-4 overflow-x-auto">
          <table class="tbl min-w-full">
            <thead>
              <tr class="text-left border-b border-gray-200">
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Rank</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80">Team</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80 text-right">Avg / Person</th>
                <th class="py-3 px-4 text-xs uppercase tracking-wide text-aggieBlue/80 text-right">Total Points</th>
              </tr>
            </thead>
            <tbody id="teamBody" class="divide-y divide-gray-100"></tbody>
          </table>
          <div id="teamEmpty" class="hidden py-8 text-center font-ui text-ink/60">No teams found.</div>
          <div class="mt-3 flex justify-center">
            <button id="teamToggleBtn" class="px-4 py-2 rounded-lg border border-aggieBlue/20 font-ui hover:bg-aggieBlue/5">See all</button>
          </div>
        </div>
      </div>

    </section>
  </main>

  <footer class="border-t border-gray-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-sm font-ui text-ink/60">
      © <span id="year"></span> Aggie Points.
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>
  <script>
    const $ = s=>document.querySelector(s);
    const esc = s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    $("#year").textContent = new Date().getFullYear();

    // ----------------------------
    // Boot
    // ----------------------------
    (async () => {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) { window.location.href = (typeof LOGIN_PAGE !== 'undefined' && LOGIN_PAGE) ? LOGIN_PAGE : "login.html"; return; }

      const { data: { user } } = await sb.auth.getUser();
      $("#acctName").textContent = user?.user_metadata?.display_name || user?.email || "Account";

      await refreshProfileSummary();   // sets names + points + initial ranks
      await loadIndividuals();         // renders & forces Tn overwrite for Summary
      await loadTeams();               // renders & syncs Summary team rank
      wireSearch();

      // Final idempotent syncs
      syncSummaryIndividualRankFromAll(); // use full list (not just visible)
      syncSummaryTeamRank();
    })();

    // ----------------------------
    // Global State
    // ----------------------------
    let USER_TEAM_NAME = null;
    let USER_DISPLAY_NAME = null;
    let USER_FALLBACK_NAME = null; // name from profiles (if present)
    let TEAMS = [];        // [{team,total,avg,rankLabel}]
    let INDIVIDUALS = [];  // [{name,team,points}]

    // ----------------------------
    // Utils
    // ----------------------------
    function computeRankLabelsByValue(vals){
      const labels=[],n=vals.length;let rank=1;
      for(let i=0;i<n;){let j=i+1;while(j<n&&vals[j]===vals[i])j++;
        const lbl=j-i>1?`T${rank}`:`${rank}`;
        for(let k=i;k<j;k++)labels[k]=lbl;rank+=j-i;i=j;}
      return labels;
    }
    function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }
    function fmt(num, digits=1){
      return (num == null || Number.isNaN(num)) ? '—'
           : (Math.round(num*10**digits)/10**digits).toFixed(digits);
    }
    function normalizeKey(s){
      return (s||"")
        .toString()
        .toLowerCase()
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'')      // strip diacritics
        .replace(/[^a-z0-9]+/g,' ')          // non-alnum -> space (handles apostrophes)
        .trim()
        .replace(/\s+/g,' ');                // collapse spaces
    }

    // ----------------------------
    // Summary setters
    // ----------------------------
    function setSummaryTeamRankText(text) { $("#teamRank").textContent = text ?? "—"; }
    function setSummaryIndividualRankText(text) { $("#individualRank").textContent = text ?? "—"; }

    function applySummary(prof) {
      const pts = prof?.points_total ?? 0;
      $("#pointsTotal").textContent = pts;

      // Show DB value first; we'll ALWAYS overwrite with table-derived Tn later
      const dbInd = (prof?.rank == null) ? '—' : (prof?.individual_is_tied ? `T${prof.rank}` : String(prof.rank));
      setSummaryIndividualRankText(dbInd);
      setSummaryTeamRankText('—');
    }

    async function refreshProfileSummary() {
      try {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        USER_DISPLAY_NAME = (user?.user_metadata?.display_name || user?.user_metadata?.full_name || "").trim() || null;

        let { data: prof, error } = await sb
          .from("profiles")
          .select("points_total, rank, individual_is_tied, team_rank, team_is_tied, team_name, full_name, display_name")
          .eq("id", user.id)
          .single();

        if (error) {
          const fb = await sb
            .from("profiles")
            .select("points_total, rank, individual_is_tied, team_rank, team_is_tied")
            .eq("id", user.id)
            .single();
          prof = fb.data;
          if (fb.error) console.warn("profiles error", error || fb.error);
        }

        if (prof) {
          applySummary(prof);

          // names for matching
          USER_FALLBACK_NAME = (prof.display_name || prof.full_name || "").trim() || null;

          // team for matching
          const metaTeam = user?.user_metadata?.team_name || user?.user_metadata?.team || null;
          USER_TEAM_NAME = (typeof prof.team_name === "string" && prof.team_name.trim().length)
            ? prof.team_name.trim()
            : (typeof metaTeam === "string" && metaTeam.trim().length ? metaTeam.trim() : null);
        }
      } catch (e) {
        console.warn("profiles fetch crashed", e);
      }
    }

    // ----------------------------
    // Individuals
    // ----------------------------
    let showAllIndividuals = false;
    let IND_FILTER = "";

    async function loadIndividuals(){
      const limit = showAllIndividuals ? null : 10;
      const {data,error} = await sb.rpc("leaderboard_top_individuals", { limit_n: limit });
      if(error){ console.warn("leaderboard_top_individuals", error); return; }

      INDIVIDUALS = (data || []).map(r => ({
        name: r.name ?? "",
        team: r.team ?? "",
        points: Number(r.points ?? 0)
      }));

      // Ensure consistent ordering for rank calculation
      INDIVIDUALS.sort((a,b)=> (b.points - a.points) || a.name.localeCompare(b.name));

      renderIndividuals(applyIndFilter(IND_FILTER));
      $("#indCount").textContent = showAllIndividuals ? `${INDIVIDUALS.length} total` : "Top 10";
      $("#indToggleBtn").textContent = showAllIndividuals ? "See top 10" : "See all";

      // Force Summary → Individual Rank to tie-aware Tn (using FULL list, not just visible)
      syncSummaryIndividualRankFromAll();
      // If we inferred team from my individual row, we can also sync team later after TEAMS load
    }

    function applyIndFilter(q){
      if(!q) return INDIVIDUALS;
      const key = normalizeKey(q);
      return INDIVIDUALS.filter(r =>
        normalizeKey(r.name).includes(key) || normalizeKey(r.team).includes(key)
      );
    }

    function renderIndividuals(rows){
      const body=$("#indBody"), empty=$("#indEmpty");
      body.innerHTML="";
      if(!rows.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");

      const pts = rows.map(r=>r.points);
      const ranks = computeRankLabelsByValue(pts);

      rows.forEach((r,i)=>{
        body.insertAdjacentHTML("beforeend",`
          <tr class="hover:bg-aggieBlue/5">
            <td class="py-3 px-4 font-ui">${ranks[i]}</td>
            <td class="py-3 px-4 font-ui">${esc(r.name)}</td>
            <td class="py-3 px-4 font-ui">${esc(r.team)}</td>
            <td class="py-3 px-4 font-ui font-semibold text-aggieBlue">${r.points}</td>
          </tr>
        `);
      });
    }

    $("#indToggleBtn").addEventListener("click", async () => {
      showAllIndividuals = !showAllIndividuals;
      await loadIndividuals();
      renderIndividuals(applyIndFilter(IND_FILTER));
      syncSummaryIndividualRankFromAll();
    });

    function wireSearch(){
      $("#searchInput")?.addEventListener("input", (e) => {
        IND_FILTER = (e.target.value || "").trim();
        renderIndividuals(applyIndFilter(IND_FILTER));
        // no need to resync here; summary rank uses FULL list
      });
      $("#clearSearch")?.addEventListener("click", () => {
        IND_FILTER = "";
        $("#searchInput").value = "";
        renderIndividuals(INDIVIDUALS);
      });
    }

    // Overwrite Summary Individual Rank using FULL leaderboard (guarantees Tn)
    function syncSummaryIndividualRankFromAll() {
      if (!INDIVIDUALS?.length) return;

      // Compute labels on the full, sorted list
      const pts = INDIVIDUALS.map(r => r.points);
      const ranks = computeRankLabelsByValue(pts);

      const keys = [
        normalizeKey(USER_DISPLAY_NAME),
        normalizeKey(USER_FALLBACK_NAME)
      ].filter(Boolean);

      let idx = -1;
      for (const k of keys) {
        idx = INDIVIDUALS.findIndex(r => normalizeKey(r.name) === k);
        if (idx < 0) idx = INDIVIDUALS.findIndex(r => {
          const n = normalizeKey(r.name);
          return n.includes(k) || k.includes(n);
        });
        if (idx >= 0) break;
      }

      if (idx >= 0 && ranks[idx]) {
        setSummaryIndividualRankText(ranks[idx]); // e.g., "T2"
        // If team name still missing, infer from my row
        if (!USER_TEAM_NAME) USER_TEAM_NAME = INDIVIDUALS[idx].team || USER_TEAM_NAME;
      }
    }

    // ----------------------------
    // Teams (avg/person)
    // ----------------------------
    let showAllTeams = false;

    async function fetchTeamTotalsWithAvg() {
      const { data, error } = await sb
        .from('v_team_totals_with_avg')
        .select('team_name,total_points,avg_points_per_person');
      if (error) { console.warn('v_team_totals_with_avg error', error); return []; }

      return (data || []).map(r => ({
        team: r.team_name ?? 'Unknown',
        total: toNum(r.total_points),
        avg: (r.avg_points_per_person == null) ? null : Number(r.avg_points_per_person)
      }));
    }

    async function loadTeams(){
      let rows = await fetchTeamTotalsWithAvg();

      rows.sort((a,b)=>{
        const av = (a.avg == null) ? -Infinity : a.avg;
        const bv = (b.avg == null) ? -Infinity : b.avg;
        if (bv !== av) return bv - av;
        if (b.total !== a.total) return b.total - a.total;
        return a.team.localeCompare(b.team);
      });

      const avgs = rows.map(r => (r.avg == null ? -Infinity : r.avg));
      const ranks = computeRankLabelsByValue(avgs);
      rows = rows.map((r,i)=>({ ...r, rankLabel: ranks[i] }));

      TEAMS = rows;

      const visible = showAllTeams ? TEAMS : TEAMS.slice(0, 5);
      renderTeams(visible);

      $("#teamCount").textContent = showAllTeams ? `${TEAMS.length} total` : "Top 5";
      $("#teamToggleBtn").textContent = showAllTeams ? "See top 5" : "See all";

      syncSummaryTeamRank();
    }

    function renderTeams(rows){
      const body=$("#teamBody"), empty=$("#teamEmpty");
      body.innerHTML="";
      if(!rows.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");

      rows.forEach((r)=>{
        body.insertAdjacentHTML("beforeend",`
          <tr class="hover:bg-aggieBlue/5">
            <td class="py-3 px-4 font-ui">${r.rankLabel}</td>
            <td class="py-3 px-4 font-ui font-semibold text-aggieBlue">${esc(r.team)}</td>
            <td class="py-3 px-4 font-ui text-right">${fmt(r.avg,1)}</td>
            <td class="py-3 px-4 font-ui text-right">${r.total}</td>
          </tr>
        `);
      });
    }

    $("#teamToggleBtn").addEventListener("click", async () => {
      showAllTeams = !showAllTeams;
      await loadTeams();
    });

    function syncSummaryTeamRank(){
      if (!TEAMS?.length) return;

      // Try multiple keys for robustness
      const candidates = [
        normalizeKey(USER_TEAM_NAME),
        normalizeKey((INDIVIDUALS.find(r => normalizeKey(r.name) === normalizeKey(USER_DISPLAY_NAME))||{}).team),
        normalizeKey((INDIVIDUALS.find(r => normalizeKey(r.name) === normalizeKey(USER_FALLBACK_NAME))||{}).team),
      ].filter(Boolean);

      for (const key of candidates) {
        if (!key) continue;

        // exact key match
        let found = TEAMS.find(t => normalizeKey(t.team) === key);
        if (found?.rankLabel) { setSummaryTeamRankText(found.rankLabel); return; }

        // fuzzy contains match (handles punctuation/apostrophes)
        found = TEAMS.find(t => {
          const tt = normalizeKey(t.team);
          return tt.includes(key) || key.includes(tt);
        });
        if (found?.rankLabel) { setSummaryTeamRankText(found.rankLabel); return; }
      }

      // If still nothing, leave as '—'
    }
  </script>
</body>
</html>
