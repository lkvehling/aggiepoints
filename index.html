<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aggie Points Check-In</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header, footer { margin-bottom: 20px; }
    .event { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .msg { color: green; margin-top: 5px; }
  </style>
</head>
<body>

  <header>
    <h1>Aggie Points Check-In</h1>
    <div id="userStatus">Checking login...</div>
  </header>

  <main>
    <h2>Today's Events</h2>
    <div id="events">Loading events...</div>
  </main>

  <footer>
    <p>UC Davis Women's Water Polo Team</p>
  </footer>

  <script>
    // Supabase credentials
    const SUPABASE_URL = "https://gtnptxnkminqmjnnfxie.supabase.co";
    const SUPABASE_KEY = "YOUR_ANON_KEY_HERE"; // replace with your anon key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    // Load logged-in user
    async function getUser() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        document.getElementById("userStatus").textContent = "Not logged in.";
        return null;
      }
      currentUser = user;
      document.getElementById("userStatus").textContent = `Logged in as: ${user.email}`;
      return user;
    }

    // Load today‚Äôs events
    async function loadEvents() {
      const user = await getUser();
      if (!user) return;

      const today = new Date();
      const start = new Date(today.setHours(0,0,0,0)).toISOString();
      const end = new Date(today.setHours(23,59,59,999)).toISOString();

      const { data: events, error } = await supabase
        .from("events")
        .select("*")
        .gte("start_time", start)
        .lte("end_time", end)
        .order("start_time", { ascending: true });

      const container = document.getElementById("events");
      container.innerHTML = "";

      if (error) {
        console.error(error);
        container.innerHTML = "<p>Failed to load events.</p>";
        return;
      }

      if (!events || events.length === 0) {
        container.innerHTML = "<p>No events scheduled for today.</p>";
        return;
      }

      events.forEach(event => {
        const div = document.createElement("div");
        div.classList.add("event");
        div.innerHTML = `
          <h3>${event.name}</h3>
          <p>${event.location || ""}</p>
          <p>${new Date(event.start_time).toLocaleString()} - ${new Date(event.end_time).toLocaleString()}</p>
          <p>Points: ${event.points || 0}</p>
          <button onclick="checkIn('${event.id}')">Check In</button>
          <p id="msg-${event.id}" class="msg"></p>
        `;
        container.appendChild(div);
      });
    }

    // Check in function
    async function checkIn(eventId) {
      if (!currentUser) {
        alert("You must be logged in to check in!");
        return;
      }

      const { error } = await supabase
        .from("checkins")
        .insert([{ user_id: currentUser.id, event_id: eventId }]);

      const msg = document.getElementById(`msg-${eventId}`);

      if (error) {
        if (error.message.includes("duplicate")) {
          msg.textContent = "‚úÖ Already checked in!";
        } else {
          msg.textContent = "‚ùå Error: " + error.message;
        }
      } else {
        msg.textContent = "üéâ Successfully checked in!";
      }
    }

    // Initialize page
    loadEvents();
  </script>

</body>
</html>
