<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aggie Points Check-In</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
    h1, h2 { text-align: center; }
    .hidden { display: none; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 10px auto;
      max-width: 500px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    input, button {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled { background: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Aggie Points</h1>

  <!-- Login form -->
  <div id="auth-section">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="signIn()">Sign In</button>
    <button onclick="signUp()">Register</button>
    <p id="auth-message"></p>
  </div>

  <!-- Events list -->
  <div id="events-section" class="hidden">
    <h2>Today's Events</h2>
    <div id="events"></div>
    <button onclick="signOut()">Log Out</button>
  </div>

  <script>
    // ✅ Supabase setup
    const SUPABASE_URL = "https://gtnptxnkminqmjnnfxie.supabase.co";
    const SUPABASE_KEY = "YOUR_ANON_KEY"; // replace with your anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ✅ Google Sheet CSV link
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKTWEbVoSyYdw6wVVbIuql9hb_NoAt7jcLoFfKI2PCz9UA3z8PJwkrWcFDjbEbGj9FVb_R_6r2Y2es/pub?gid=0&single=true&output=csv";

    // --- AUTH FUNCTIONS ---
    async function signIn() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        document.getElementById("auth-message").innerText = "❌ " + error.message;
      } else {
        showEvents();
      }
    }

    async function signUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) {
        document.getElementById("auth-message").innerText = "❌ " + error.message;
      } else {
        document.getElementById("auth-message").innerText = "✅ Check your email to confirm your account.";
      }
    }

    async function signOut() {
      await supabase.auth.signOut();
      document.getElementById("auth-section").classList.remove("hidden");
      document.getElementById("events-section").classList.add("hidden");
    }

    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        showEvents();
      }
    });

    // --- EVENTS FUNCTIONS ---
    async function loadEvents() {
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim());
      const events = rows.slice(1).map(r => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = r[i].trim());
        return obj;
      });

      const today = new Date().toISOString().split("T")[0];
      return events.filter(ev => ev["Start Time"].startsWith(today));
    }

    async function checkIn(event) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("Please log in first.");
        return;
      }

      const eventId = event["Event Name"];

      // Check if already checked in
      const { data: existing } = await supabase
        .from("checkins")
        .select("*")
        .eq("event_id", eventId)
        .eq("user_id", user.id);

      if (existing && existing.length > 0) {
        alert("⚠️ You’ve already checked in for this event!");
        return;
      }

      // Insert new check-in
      const { error } = await supabase
        .from("checkins")
        .insert([{ event_id: eventId, user_id: user.id }]);

      if (error) {
        alert("❌ Error: " + error.message);
      } else {
        alert("✅ Successfully checked in!");
      }
    }

    async function showEvents() {
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("events-section").classList.remove("hidden");

      const events = await loadEvents();
      const container = document.getElementById("events");
      container.innerHTML = "";

      if (events.length === 0) {
        container.innerHTML = "<p>No events today.</p>";
        return;
      }

      events.forEach(ev => {
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <h3>${ev["Event Name"]}</h3>
          <p><strong>Time:</strong> ${ev["Start Time"]} → ${ev["End Time"]}</p>
          <p><strong>Location:</strong> ${ev.Location || "TBA"}</p>
          <p><strong>Points:</strong> ${ev.Points || "N/A"}</p>
          <button onclick='checkIn(${JSON.stringify(ev)})'>Check In</button>
        `;

        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
