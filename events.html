<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aggie Points — All Events</title>

  <!-- Fonts (Raleway, Montserrat, Merriweather) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aggieBlue: "#022851",
            aggieGold: "#FFBF00",
            aggieBg: "#F7F7F7",
            ink: "#333333",
          },
          fontFamily: {
            heading: ["Raleway", "Helvetica Neue", "Arial", "sans-serif"],
            ui: ["Montserrat", "Helvetica Neue", "Arial", "sans-serif"],
            body: ["Merriweather", "Georgia", "serif"],
          },
          boxShadow: { soft: "0 6px 24px rgba(2, 40, 81, 0.08)" }
        }
      }
    }
  </script>

  <style>
    .card { transition: transform .15s ease, box-shadow .15s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(2,40,81,.12); }
  </style>
</head>

<body class="min-h-screen bg-aggieBg text-ink font-body">
  <!-- Header / Nav -->
  <header class="bg-aggieBlue text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-3">
        <a href="index.html" class="flex items-center">
          <span class="font-ui text-xl font-semibold tracking-wide">Aggie Points</span>
        </a>

        <nav class="hidden md:flex items-center gap-8 font-ui">
          <a href="index.html" class="hover:text-aggieGold">Home</a>
          <a href="leaderboard.html" class="hover:text-aggieGold">Leaderboard</a>
          <a href="events.html" class="hover:text-aggieGold text-aggieGold">All Events</a>
          <a href="about.html" class="hover:text-aggieGold">About</a>

          <!-- Account dropdown -->
          <div class="relative">
            <button id="acctBtn" class="hover:text-aggieGold flex items-center gap-2">
              <span id="acctName" class="font-medium">Account</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <div id="acctMenu" class="absolute right-0 mt-2 w-44 bg-white text-ink rounded-lg shadow-soft py-2 hidden">
              <a href="settings.html" class="block px-4 py-2 hover:bg-gray-100">Settings</a>
              <button id="logoutBtn" class="w-full text-left block px-4 py-2 hover:bg-gray-100">Log out</button>
            </div>
          </div>
        </nav>

        <!-- Mobile menu button -->
        <button id="mobileMenuBtn" class="md:hidden inline-flex items-center justify-center p-2 rounded-md hover:bg-white/10">
          <span class="sr-only">Open main menu</span>
          <svg class="h-6 w-6" viewBox="0 0 24 24" stroke="currentColor" fill="none">
            <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile menu -->
    <div id="mobileMenu" class="md:hidden hidden border-t border-white/10">
      <div class="space-y-1 px-4 pb-4 pt-2 font-ui">
        <a href="index.html" class="block px-3 py-2 rounded-md hover:bg-white/10">Home</a>
        <a href="leaderboard.html" class="block px-3 py-2 rounded-md hover:bg-white/10">Leaderboard</a>
        <a href="events.html" class="block px-3 py-2 rounded-md hover:bg-white/10">All Events</a>
        <a href="about.html" class="block px-3 py-2 rounded-md hover:bg-white/10">About</a>
        <a href="settings.html" class="block px-3 py-2 rounded-md hover:bg-white/10">Settings</a>
        <button id="logoutBtnMobile" class="w-full text-left block px-3 py-2 rounded-md hover:bg-white/10">Log out</button>
      </div>
    </div>
  </header>

  <!-- Page Header -->
  <section class="bg-gradient-to-r from-aggieBlue to-[#0a3b7b] text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
      <h1 class="font-heading text-3xl sm:text-4xl font-extrabold tracking-tight">All Events</h1>
      <p class="mt-1 font-ui text-white/90">Plan ahead. If an event is today and in the check-in window, you can check in from here or from Home.</p>

      <!-- Search bar -->
      <div class="mt-6">
        <div class="relative max-w-xl">
          <input id="searchInput" type="search" placeholder="Search by title or location..."
                 class="w-full rounded-xl bg-white/95 text-ink placeholder:text-ink/50 ring-1 ring-white/30 focus:ring-2 focus:ring-aggieGold px-4 py-3 font-ui shadow-soft" />
          <svg class="absolute right-4 top-1/2 -translate-y-1/2 h-5 w-5 text-ink/50" viewBox="0 0 24 24" fill="none">
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
            <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <p id="searchHint" class="mt-2 text-sm font-ui text-white/75 hidden"></p>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 gap-6">
      <!-- This Week -->
      <section id="week" class="card bg-white rounded-2xl shadow-soft border border-aggieBlue/10">
        <div class="p-6">
          <div class="flex items-baseline justify-between mb-2">
            <h2 class="font-ui text-xl font-semibold text-aggieBlue">This Week</h2>
            <p id="weekRangeText" class="font-ui text-sm text-ink/60"></p>
          </div>
          <div id="weekList" class="space-y-4"></div>
          <div id="weekEmpty" class="hidden font-ui text-ink/60">No more events this week.</div>
        </div>
      </section>

      <!-- This Month -->
      <section id="month" class="card bg-white rounded-2xl shadow-soft border border-aggieBlue/10">
        <div class="p-6">
          <div class="flex items-baseline justify-between mb-2">
            <h2 class="font-ui text-xl font-semibold text-aggieBlue">This Month</h2>
            <p id="monthRangeText" class="font-ui text-sm text-ink/60"></p>
          </div>
          <div id="monthList" class="space-y-4"></div>
        </div>
      </section>

      <!-- All Upcoming -->
      <section id="upcoming" class="card bg-white rounded-2xl shadow-soft border border-aggieBlue/10">
        <div class="p-6">
          <div class="flex items-baseline justify-between mb-2">
            <h2 class="font-ui text-xl font-semibold text-aggieBlue">All Upcoming</h2>
          </div>
          <div id="upcomingList" class="space-y-4"></div>
          <div id="upcomingEmpty" class="hidden font-ui text-ink/60">No upcoming events.</div>
        </div>
      </section>

      <!-- Past Events (collapsed by default) -->
      <section id="past" class="card bg-white rounded-2xl shadow-soft border border-aggieBlue/10">
        <div class="p-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="font-ui text-xl font-semibold text-aggieBlue">Past Events</h2>
              <p class="font-ui text-sm text-ink/60">Most recent first. Collapsed by default.</p>
            </div>
            <button id="togglePastBtn"
              class="font-ui px-3 py-1.5 rounded-lg bg-aggieBlue text-white hover:brightness-110">
              Show past events
            </button>
          </div>
          <div id="pastList" class="space-y-4 mt-4 hidden"></div>
          <div id="pastEmpty" class="hidden font-ui text-ink/60 mt-4">No past events found.</div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-sm font-ui text-ink/60">
      © <span id="yearText"></span> Aggie Points. UC Davis-inspired theme.
    </div>
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>
  <script src="checkin.js"></script>

  <script>
    // ===== Helpers =====
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const toggle = (el, show) => { if (!el) return; el.classList[show ? 'remove' : 'add']('hidden'); };
    const TZ = 'America/Los_Angeles';

    // Time helpers
    const toPT  = (ts) => new Date(new Date(ts).toLocaleString('en-US', { timeZone: TZ }));
    const nowPT = () => new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));

    // --- Compact "Sat, Sep 13 · 12:10 AM–11:59 AM" formatting ---
    const DOW_ABBR = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const MON_ABBR = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function fmtMonthDayDow(ts) {
      const d = toPT(ts);
      return `${DOW_ABBR[d.getDay()]}, ${MON_ABBR[d.getMonth()]} ${d.getDate()}`;
    }

    function hm12WithMeridian(d) {
      let h = d.getHours() % 12; if (h === 0) h = 12;
      const m = String(d.getMinutes()).padStart(2, '0');
      const mer = d.getHours() >= 12 ? 'PM' : 'AM';
      return `${h}:${m} ${mer}`;
    }

    function fmtTimeRangeFull(start_ts, end_ts) {
      const s = toPT(start_ts);
      const e = toPT(end_ts);
      // Always show both meridians
      return `${hm12WithMeridian(s)}–${hm12WithMeridian(e)}`;
    }

    function fmtEventLine(start_ts, end_ts) {
      return `${fmtMonthDayDow(start_ts)} · ${fmtTimeRangeFull(start_ts, end_ts)}`;
    }

    const isTodayPT = (ts) => {
      const d = toPT(ts), n = nowPT();
      return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate();
    };

    // Check-in window (open 20 min before start → close 10 min before end)
    const WINDOW_BEFORE_MIN = 20;
    const WINDOW_CLOSE_MIN  = 10;
    const openAtPT  = (start_ts) => new Date(toPT(start_ts).getTime() - WINDOW_BEFORE_MIN * 60 * 1000);
    const closeAtPT = (end_ts)   => new Date(toPT(end_ts).getTime()   - WINDOW_CLOSE_MIN  * 60 * 1000);
    const isCheckinWindow = (start_ts, end_ts) => {
      const n = nowPT();
      return n >= openAtPT(start_ts) && n <= closeAtPT(end_ts);
    };

    const escapeHtml = (s) => (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    function mapsLink(locationText) {
      if (!locationText) return null;
      return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(locationText);
    }

    // Toast
    function toast(message, { variant = 'info', timeout = 3500 } = {}) {
      const root = document.querySelector('#toast-root > div');
      if (!root) return alert(message);
      const variants = {
        success: 'bg-green-100 text-green-900 ring-1 ring-green-300',
        error:   'bg-red-100 text-red-900 ring-1 ring-red-300',
        info:    'bg-aggieBlue/10 text-aggieBlue ring-1 ring-aggieBlue/30',
        warn:    'bg-yellow-100 text-yellow-900 ring-1 ring-yellow-300'
      };
      const cls = variants[variant] || variants.info;
      const el = document.createElement('div');
      el.setAttribute('role','status');
      el.className = 'pointer-events-auto max-w-sm w-[360px] rounded-2xl shadow-soft px-4 py-3 font-ui text-sm backdrop-blur flex items-start gap-3 ' + cls;
      el.innerHTML = `
        <div class="shrink-0 pt-0.5">${variant==='success'?'✅':variant==='warn'?'⚠️':variant==='info'?'ℹ️':'❌'}</div>
        <div class="min-w-0 leading-snug">${message}</div>
        <button class="ml-auto shrink-0 opacity-70 hover:opacity-100" aria-label="Close">✕</button>
      `;
      el.querySelector('button').addEventListener('click', () => { el.classList.add('animate-fade-out'); setTimeout(() => el.remove(), 150); });
      root.appendChild(el);
      if (timeout > 0) setTimeout(() => { el.classList.add('animate-fade-out'); setTimeout(() => el.remove(), 150); }, timeout);
    }
    (function injectToastAnim(){
      const style = document.createElement('style');
      style.textContent = `@keyframes toast-fade-out { to { opacity: 0; transform: translateY(-4px); } } .animate-fade-out { animation: toast-fade-out .15s ease forwards; }`;
      document.head.appendChild(style);
    })();

    function showCheckinError(err) {
      const code = err?.code;
      const details = err?.details || '';
      if (code === '22P02' || /invalid input syntax for type uuid/i.test(details)) return 'Invalid event id. Please refresh and try again.';
      if (code === '23503' || /foreign key/i.test(details))               return 'This event no longer exists. Please refresh the page.';
      if (code === 'PGRST301' || code === '401' || /JWT|auth/i.test(details)) return 'You must be signed in to check in.';
      if (/Missing required input parameter: event_id/i.test(details))    return 'Check-in misconfigured (missing event id). Please contact an admin.';
      if (code === '42501')                                               return 'You do not have permission to check in to this event.';
      if (/outside_geofence/i.test(details))                              return 'You must be at the venue to check in. If you are here, please close the tab, ensure precision location is on, move closer to the center of the event, and reopen Aggie Points.';
      if (/outside_time_window/i.test(details))                           return 'This event is not currently active (20 min before start → 10 min before end).';
      if (/missing_lat_lng/i.test(details))                               return 'We need your location to check in. Please turn on location access ("Privacy & Security" > "Location Services") for your browser (Safari/Chrome) and try again!';
      if (/low_accuracy/i.test(details))                                  return 'Your location is not precise enough. Please check in using a smartphone with Precision Location enabled. Also can close the tab, move closer to center of event, and reopen Aggie Points.';
      if (/missing_accuracy/i.test(details))                              return 'We could not read your GPS accuracy. Try again on a smartphone with GPS enabled.';
      return err?.message || 'Check-in failed. Please try again.';
    }

    function uiError(el, err) {
      const msg = [
        'Could not load events.',
        err?.code ? `Code: ${err.code}` : '',
        err?.details || err?.message || ''
      ].filter(Boolean).join(' ');
      console.error('events load error →', err);
      el.innerHTML = `<div class="mt-4 text-center text-red-600 font-ui">${msg}</div>`;
    }

    // Local "checked" cache
    function getCheckedSet() {
      try { return new Set(JSON.parse(localStorage.getItem('aggie_checked_in_ids') || '[]')); }
      catch { return new Set(); }
    }

    // Row renderer — points in middle line (big); Past uses compact size but same date line.
    function eventRow(ev, opts = {}) {
      const { forceClosed = false, checkedOverride = null, compact = false } = opts;
      const today   = isTodayPT(ev.start_ts);
      const canNow  = isCheckinWindow(ev.start_ts, ev.end_ts);
      const isLocalChecked = getCheckedSet().has(ev.id);

      const timeLine = fmtEventLine(ev.start_ts, ev.end_ts);

      const pointsHTML = (typeof ev.points === 'number')
        ? `<span class="inline-flex items-center rounded-full bg-aggieGold/20 ${compact ? 'px-2 py-0.5 text-[12px]' : 'px-2.5 py-1 text-sm md:text-base'} font-ui font-semibold text-aggieBlue">+${ev.points} pts</span>`
        : '';

      const checkedBadge = `<span class="inline-flex items-center rounded-lg bg-green-100 text-green-700 ${compact?'px-2 py-0.5 text-[11px]':'px-3 py-1.5 text-sm'} font-ui">Checked in</span>`;
      const closedBadge  = `<span class="inline-flex items-center rounded-lg bg-gray-200 text-gray-700 ${compact?'px-2 py-0.5 text-[11px]':'px-3 py-1.5 text-sm'} font-ui">Closed</span>`;
      const notOpenBadge = `<span class="inline-flex items-center rounded-lg bg-gray-200 text-gray-700 ${compact?'px-2 py-0.5 text-[11px]':'px-3 py-1.5 text-sm'} font-ui">Not Open Yet</span>`;

      let action;
      if (checkedOverride === true) {
        action = checkedBadge;
      } else if (forceClosed) {
        action = closedBadge;
      } else if (isLocalChecked) {
        action = checkedBadge;
      } else if (today && canNow) {
        action = `<button
          class="checkin-btn ${compact?'px-2 py-0.5 text-[11px]':'px-3 py-1.5 text-sm'} rounded-lg bg-aggieGold text-aggieBlue font-ui hover:brightness-95"
          data-event-id="${ev.id}"
          data-event-name="${escapeHtml(ev.title)}"
          data-event-points="${ev.points ?? ''}">
          Check in
        </button>`;
      } else if (today) {
        action = nowPT() > closeAtPT(ev.end_ts) ? closedBadge : notOpenBadge;
      } else {
        action = notOpenBadge;
      }

      const hasLoc = !!(ev.location && ev.location.trim());
      const locHTML = hasLoc ? `
        <p class="font-ui ${compact?'text-[12px]':'text-sm'} text-aggieBlue mt-0.5 flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="${compact?'w-3.5 h-3.5':'w-4 h-4'} shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 10c0 7-7.5 10.5-7.5 10.5S4.5 17 4.5 10a7.5 7.5 0 1115 0z" />
          </svg>
          <a href="${mapsLink(ev.location)}" target="_blank" rel="noopener noreferrer" class="truncate hover:underline" aria-label="Open ${escapeHtml(ev.location)} in Google Maps">
            ${escapeHtml(ev.location)}
          </a>
        </p>` : '';

      return `
        <article class="rounded-2xl border border-aggieBlue/10 bg-white p-4 shadow-soft"
                 data-title="${escapeHtml(ev.title).toLowerCase()}"
                 data-location="${escapeHtml(ev.location||'').toLowerCase()}">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="min-w-0">
              <h3 class="font-ui text-ink ${compact?'text-[15px]':'text-base md:text-lg'} font-semibold leading-tight truncate">
                ${escapeHtml(ev.title)}
              </h3>

              <!-- Middle line: date (single-line, truncates) + BIG points (no wrap) -->
              <div class="mt-0.5 flex items-center gap-2">
                <p class="font-ui ${compact?'text-[12px]':'text-xs sm:text-sm md:text-base'} text-ink/80
                                  flex-1 min-w-0 truncate whitespace-nowrap">
                  ${timeLine}
                </p>
                <span class="shrink-0 whitespace-nowrap">
                  ${pointsHTML}
                </span>
              </div>

              ${locHTML}
            </div>
            <div class="shrink-0">
              <span class="checkin-slot"
                    data-event-id="${ev.id}"
                    data-title-full="${escapeHtml(ev.title)}"
                    data-points="${ev.points ?? ''}"
                    data-start="${ev.start_ts}"
                    data-end="${ev.end_ts}">
                ${action}
              </span>
            </div>
          </div>
        </article>
      `;
    }

    // Reconcile local vs server truth
    async function reconcileCheckedInsFromServer() {
      try {
        const slots = Array.from(document.querySelectorAll('.checkin-slot[data-event-id]'));
        const eventIds = [...new Set(slots.map(s => s.getAttribute('data-event-id')).filter(Boolean))];
        if (!eventIds.length) return;
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;
        const { data: rows, error } = await sb
          .from('checkins')
          .select('event_id')
          .eq('user_id', user.id)
          .in('event_id', eventIds);
        if (error) { console.warn('reconcile error', error); return; }
        const serverSet = new Set((rows || []).map(r => r.event_id));
        const LS_KEY = 'aggie_checked_in_ids';
        const getLocal = () => {
          try { return new Set(JSON.parse(localStorage.getItem(LS_KEY) || '[]')); }
          catch { return new Set(); }
        };
        const saveLocal = (set) => localStorage.setItem(LS_KEY, JSON.stringify([...set]));
        const localSet = getLocal();

        const isClosed = (end_ts) => nowPT() > new Date(toPT(end_ts).getTime() - WINDOW_CLOSE_MIN * 60 * 1000);

        localSet.forEach(id => {
          if (!serverSet.has(id)) {
            localSet.delete(id);
            document.querySelectorAll(`.checkin-slot[data-event-id="${id}"]`).forEach(slot => {
              const start = slot.getAttribute('data-start');
              const end   = slot.getAttribute('data-end');
              const title = slot.getAttribute('data-title-full') || '';
              const pts   = slot.getAttribute('data-points') || '';
              let html;
              if (start && end && isTodayPT(start) && isCheckinWindow(start, end)) {
                html = `<button
                  class="checkin-btn px-3 py-1.5 rounded-lg bg-aggieGold text-aggieBlue font-ui text-sm hover:brightness-95"
                  data-event-id="${id}"
                  data-event-name="${title}"
                  data-event-points="${pts}">
                  Check in
                </button>`;
              } else if (start && end && isTodayPT(start) && isClosed(end)) {
                html = `<span class="px-3 py-1.5 rounded-lg bg-gray-200 text-gray-700 font-ui text-sm">Closed</span>`;
              } else {
                html = `<span class="px-3 py-1.5 rounded-lg bg-gray-200 text-gray-700 font-ui text-sm">Not Open Yet</span>`;
              }
              slot.innerHTML = html;
            });
          }
        });
        saveLocal(localSet);
        if (typeof window.initCheckinButtons === 'function') window.initCheckinButtons();
      } catch (e) {
        console.warn('reconcile exception', e);
      }
    }

    // Date labels
    function ordinal(n) {
      const s = ["th","st","nd","rd"], v = n % 100;
      return s[(v-20)%10] || s[v] || s[0];
    }
    function startOfDayPT(d) {
      const copy = new Date(d);
      copy.setHours(0,0,0,0);
      return copy;
    }
    // Rolling 7-day range starting today (as requested)
    function formatThisWeekRangeLabel() {
      const today = startOfDayPT(nowPT());
      const end = new Date(today); end.setDate(end.getDate() + 7);
      const sameMonth = today.getMonth() === end.getMonth();
      const sameYear = today.getFullYear() === end.getFullYear();
      if (sameMonth && sameYear) {
        const monthFull = today.toLocaleString('en-US', { timeZone: TZ, month: 'long' });
        return `${monthFull} ${today.getDate()}–${end.getDate()}${ordinal(end.getDate())}, ${today.getFullYear()}`;
      } else {
        const left = today.toLocaleString('en-US', { timeZone: TZ, month: 'short', day: 'numeric' });
        const rightMonth = end.toLocaleString('en-US', { timeZone: TZ, month: 'short' });
        return `${left} – ${rightMonth} ${end.getDate()}${ordinal(end.getDate())}, ${end.getFullYear()}`;
      }
    }
    function formatThisMonthLabel() {
      const now = nowPT();
      const monthFull = now.toLocaleString('en-US', { timeZone: TZ, month: 'long' });
      return `${monthFull} ${now.getFullYear()}`;
    }

    const isPast = (end_ts) => nowPT() > closeAtPT(end_ts);

    // --- Auth gate (mirrors index.html) ---
    async function ensureAuthed() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        window.location.href = (typeof LOGIN_PAGE !== 'undefined' && LOGIN_PAGE) ? LOGIN_PAGE : 'login.html';
        return null;
      }
      return session;
    }

    // Page boot
    (async () => {
      // Header UI
      $('#mobileMenuBtn')?.addEventListener('click', () => { const m = $('#mobileMenu'); if (m) m.classList.toggle('hidden'); });
      $('#acctBtn')?.addEventListener('click', () => { const m = $('#acctMenu'); if (m) m.classList.toggle('hidden'); });
      $('#yearText').textContent = new Date().getFullYear();

      // Require auth before loading data
      const session = await ensureAuthed(); if (!session) return;

      // Account label + react to auth state
      try {
        const { data: { user } } = await sb.auth.getUser();
        if (user) $('#acctName').textContent = user.user_metadata?.display_name || user.email || 'Account';
        sb.auth.onAuthStateChange(async (_evt, sess) => {
          if (sess?.user) $('#acctName').textContent = sess.user.user_metadata?.display_name || sess.user.email || 'Account';
        });
      } catch {}

      const doLogout = async () => { await sb.auth.signOut(); window.location.href = (typeof LOGIN_PAGE !== 'undefined' && LOGIN_PAGE) ? LOGIN_PAGE : 'login.html'; };
      $('#logoutBtn')?.addEventListener('click', doLogout);
      $('#logoutBtnMobile')?.addEventListener('click', doLogout);

      // Set section labels
      $('#weekRangeText').textContent  = formatThisWeekRangeLabel();
      $('#monthRangeText').textContent = formatThisMonthLabel();

      // Render helper
      function renderListInto(listEl, rows, { forceClosed = false, compact = false, checkedSet = null } = {}) {
        listEl.innerHTML = (rows || []).map(ev => eventRow(ev, {
          forceClosed,
          compact,
          checkedOverride: checkedSet ? checkedSet.has(ev.id) : null
        })).join('');
        initCheckinButtons();
      }

      // Load a view and hide past events
      async function loadSection(viewName, listEl, emptyEl) {
        const { data, error } = await sb
          .from(viewName)
          .select('id,title,start_ts,end_ts,location,points')
          .order('start_ts', { ascending: true });

        if (error) { uiError(listEl, error); toggle(emptyEl, true); return []; }

        const rows = (data || []).filter(ev => !isPast(ev.end_ts));
        renderListInto(listEl, rows);
        toggle(emptyEl, rows.length === 0);

        if (typeof window.syncCheckedInUI === 'function') window.syncCheckedInUI();
        await reconcileCheckedInsFromServer();

        return rows;
      }

      const weekListEl = $('#weekList'), weekEmptyEl = $('#weekEmpty');
      const monthListEl = $('#monthList');
      const upcomingListEl = $('#upcomingList'), upcomingEmptyEl = $('#upcomingEmpty');

      // Load base views
      await loadSection('events_this_week', weekListEl, weekEmptyEl);
      await loadSection('events_this_month_excl_week', monthListEl, null);
      await loadSection('events_upcoming', upcomingListEl, upcomingEmptyEl);

      // ---- Past Events (lazy load, collapsed) ----
      const pastListEl = $('#pastList');
      const pastEmptyEl = $('#pastEmpty');
      const togglePastBtn = $('#togglePastBtn');
      let pastLoaded = false;
      let pastOpen = false;

      async function loadPastEvents() {
        const nowISO = new Date().toISOString();
        const sinceISO = new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString(); // last 60 days
        // 1) Fetch past events
        const { data: eventsData, error: eventsErr } = await sb
          .from('events')
          .select('id,title,start_ts,end_ts,location,points')
          .lt('end_ts', nowISO)
          .gte('end_ts', sinceISO)
          .order('start_ts', { ascending: false });
        if (eventsErr) { uiError(pastListEl, eventsErr); toggle(pastEmptyEl, true); return; }

        const rows = (eventsData || []).filter(ev => isPast(ev.end_ts));
        if (!rows.length) {
          pastListEl.innerHTML = '';
          toggle(pastEmptyEl, true);
          pastLoaded = true;
          return;
        }

        // 2) Fetch which of these the current user checked into
        let checkedSet = new Set();
        try {
          const { data: { user } } = await sb.auth.getUser();
          if (user) {
            const ids = rows.map(r => r.id);
            const { data: chk, error: chkErr } = await sb
              .from('checkins')
              .select('event_id')
              .eq('user_id', user.id)
              .in('event_id', ids);
            if (!chkErr && Array.isArray(chk)) {
              checkedSet = new Set(chk.map(c => c.event_id));
            }
          }
        } catch (e) {
          console.warn('past checkins fetch error', e);
        }

        // 3) Render compact cards, Closed by default, green if checked
        renderListInto(pastListEl, rows, { forceClosed: true, compact: true, checkedSet });
        toggle(pastEmptyEl, rows.length === 0);
        pastLoaded = true;
      }

      togglePastBtn.addEventListener('click', async () => {
        pastOpen = !pastOpen;
        toggle(pastListEl, pastOpen);
        togglePastBtn.textContent = pastOpen ? 'Hide past events' : 'Show past events';
        if (pastOpen && !pastLoaded) {
          await loadPastEvents();
        }
      });

      // Search
      const searchInput = $('#searchInput');
      const searchHint = $('#searchHint');
      const params = new URLSearchParams(location.search);
      const initialQ = params.get('q'); if (initialQ) searchInput.value = initialQ;

      function applySearch(q) {
        const term = (q || '').trim().toLowerCase();
        const sections = [
          { list: weekListEl, empty: weekEmptyEl },
          { list: monthListEl, empty: null },
          { list: upcomingListEl, empty: upcomingEmptyEl },
          ...(pastLoaded ? [{ list: pastListEl, empty: pastEmptyEl }] : []),
        ];

        let totalShown = 0;

        sections.forEach(({ list, empty }) => {
          const rows = Array.from(list.querySelectorAll('[data-title]'));
          let shown = 0;
          rows.forEach(row => {
            if (!term) { row.classList.remove('hidden'); shown++; return; }
            const title = row.getAttribute('data-title') || '';
            const loc   = row.getAttribute('data-location') || '';
            const match = title.includes(term) || loc.includes(term);
            row.classList.toggle('hidden', !match);
            if (match) shown++;
          });
          if (empty) toggle(empty, term ? (shown === 0) : (rows.length === 0));
          totalShown += shown;
        });

        if (term) {
          searchHint.textContent = totalShown ? `Showing ${totalShown} matching event${totalShown===1?'':'s'}.` : `No events match “${q}”.`;
          searchHint.classList.remove('hidden');
        } else {
          searchHint.textContent = '';
          searchHint.classList.add('hidden');
        }
      }

      applySearch(searchInput.value);
      searchInput.addEventListener('input', (e) => applySearch(e.target.value));
    })();
  </script>

  <!-- Toast root -->
  <div id="toast-root" class="fixed inset-0 pointer-events-none z-[1000]">
    <div class="absolute top-4 right-4 space-y-3"></div>
  </div>
</body>
</html>
