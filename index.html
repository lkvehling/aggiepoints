<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggie Points — Home</title>

  <!-- keep your existing stylesheet/theme -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase v2 -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Your config (must define SUPABASE_URL, SUPABASE_ANON_KEY, APP_HOME, LOGIN_PAGE, and window.sb) -->
  <script defer src="auth-config.js"></script>
</head>
<body>
  <!-- ======= HEADER (preserve your existing markup/classes) ======= -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">Aggie Points</a>
      <nav class="nav">
        <a href="index.html" class="nav-link is-active">Home</a>
        <a href="events.html" class="nav-link">All Events</a>
        <a href="leaderboard.html" class="nav-link">Leaderboard</a>
      </nav>
      <div class="user-menu">
        <button id="userMenuButton" class="btn btn-secondary">Account ▾</button>
        <div id="userMenuDropdown" class="menu menu-right hidden">
          <a href="account.html" class="menu-item">Account settings</a>
          <button id="logoutBtn" class="menu-item">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ======= HERO ======= -->
  <section class="hero">
    <div class="container">
      <h1 class="hero-title">WELCOME TO AGGIE POINTS</h1>
      <p class="hero-subtitle">Track your points, check in to events, and climb the leaderboard.</p>
    </div>
  </section>

  <!-- ======= CONTENT ======= -->
  <main class="container layout-grid">
    <!-- Profile / Points (left column) -->
    <section class="card" id="profileSection">
      <h2 class="section-title">Your Status</h2>

      <div class="stats three-up">
        <div class="stat">
          <div class="stat-label">Points</div>
          <div id="profilePoints" class="stat-value">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Rank</div>
          <div id="profileRank" class="stat-value">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Team</div>
          <div id="profileTeam" class="stat-value">—</div>
        </div>
      </div>

      <div class="signed-in-as">
        Signed in as <span id="displayName">…</span>
      </div>
    </section>

    <!-- Today's Events (right column) -->
    <section class="card" id="eventsSection">
      <div class="section-header">
        <div>
          <h2 class="section-title">Today’s Events</h2>
          <div class="section-subtitle">Times shown in Pacific Time.</div>
        </div>
        <a href="events.html" class="link">See all events →</a>
      </div>

      <div id="eventsList" class="list list-spaced">
        <!-- populated by JS -->
      </div>

      <div id="noEvents" class="muted hidden">No events today.</div>
    </section>
  </main>

  <!-- ======= FOOTER (optional) ======= -->
  <footer class="site-footer">
    <div class="container">
      <span class="muted">© Aggie Points</span>
    </div>
  </footer>

  <script>
    // keep your existing dropdown behavior; minimal JS here
    document.addEventListener('click', (e) => {
      const btn = document.getElementById('userMenuButton');
      const dd  = document.getElementById('userMenuDropdown');
      if (!btn || !dd) return;
      if (btn.contains(e.target)) {
        dd.classList.toggle('hidden');
      } else if (!dd.contains(e.target)) {
        dd.classList.add('hidden');
      }
    });

    // ---- Helpers ----
    const PT = 'America/Los_Angeles';
    function fmtPT(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleString('en-US', {
        timeZone: PT,
        month: 'short', day: 'numeric',
        hour: 'numeric', minute: '2-digit'
      });
    }

    async function ensureAuth() {
      // sb is provided by auth-config.js
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        window.location.href = typeof LOGIN_PAGE !== 'undefined' ? LOGIN_PAGE : 'login.html';
        return null;
      }
      return user;
    }

    async function loadProfile(user) {
      // profiles view: id, display_name, team_name, grad_year, points_total, rank
      const { data, error } = await sb
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      if (error) {
        console.error('profiles error', error);
        return;
      }

      document.getElementById('displayName').textContent   = data.display_name || user.email || 'User';
      document.getElementById('profilePoints').textContent = (data.points_total ?? 0);
      document.getElementById('profileRank').textContent   = (data.rank ?? '—');
      document.getElementById('profileTeam').textContent   = data.team_name || '—';
    }

    async function loadTodaysEvents() {
      const list = document.getElementById('eventsList');
      const noEvents = document.getElementById('noEvents');
      list.innerHTML = '';

      const { data, error } = await sb
        .from('events_today')
        .select('*')
        .order('start_ts', { ascending: true });

      if (error) {
        console.error('events_today error', error);
        noEvents.classList.remove('hidden');
        return;
      }

      if (!data || data.length === 0) {
        noEvents.classList.remove('hidden');
        return;
      }

      noEvents.classList.add('hidden');

      data.forEach(ev => {
        const checked = !!ev.user_checked_in;

        const item = document.createElement('div');
        item.className = 'list-item event';

        // inner structure uses generic classes so your CSS keeps styling
        item.innerHTML = `
          <div class="event-main">
            <div class="event-title">${ev.title}</div>
            <div class="event-meta">
              ${fmtPT(ev.start_ts)} – ${fmtPT(ev.end_ts)} • ${ev.location ?? 'TBA'}
            </div>
            <div class="event-points">+${ev.points ?? 0} pts</div>
          </div>
          <div class="event-actions">
            <button
              class="btn ${checked ? 'btn-disabled' : 'btn-primary'} checkin-btn"
              data-event-id="${ev.id}"
              ${checked ? 'disabled' : ''}>
              ${checked ? 'Checked In' : 'Check In'}
            </button>
          </div>
        `;

        list.appendChild(item);
      });

      // Wire buttons
      document.querySelectorAll('.checkin-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const eventId = btn.getAttribute('data-event-id');
          btn.disabled = true;
          const originalText = btn.textContent;
          btn.textContent = 'Checking...';
          try {
            const { error } = await sb.rpc('checkin', { event_id: eventId });
            if (error) throw error;
            btn.textContent = 'Checked In';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-disabled');
          } catch (e) {
            console.error('checkin error', e);
            btn.disabled = false;
            btn.textContent = originalText;
            alert('Could not check in. Please try again.');
          }
        });
      });
    }

    async function main() {
      const user = await ensureAuth();
      if (!user) return;

      // logout
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        await sb.auth.signOut();
        window.location.href = typeof LOGIN_PAGE !== 'undefined' ? LOGIN_PAGE : 'login.html';
      });

      await loadProfile(user);
      await loadTodaysEvents();
    }

    window.addEventListener('load', main);
  </script>
</body>
</html>
