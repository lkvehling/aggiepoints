<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aggie Points — Events</title>

  <!-- Fonts: Raleway (headings), Montserrat (UI), Merriweather (body) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aggieBlue: "#022851",
            aggieGold: "#FFBF00",
            aggieBg: "#F7F7F7",
            ink: "#111827",
            slate: "#6B7280"
          },
          fontFamily: {
            heading: ["Raleway", "ui-sans-serif", "system-ui"],
            ui: ["Montserrat", "ui-sans-serif", "system-ui"],
            body: ["Merriweather", "ui-serif", "Georgia"]
          },
          boxShadow: {
            soft: "0 10px 25px rgba(0,0,0,0.06)"
          }
        }
      }
    }
  </script>

  <style>
    html, body { background: #F7F7F7; }
  </style>
</head>
<body class="min-h-screen text-ink font-body">
  <!-- Header -->
  <header class="bg-aggieBlue text-white">
    <div class="mx-auto max-w-6xl px-4 py-6 flex items-center justify-between">
      <h1 class="font-heading text-2xl sm:text-3xl tracking-wide">
        <span class="font-extrabold">Aggie</span> <span class="text-aggieGold font-extrabold">Points</span> — Events
      </h1>
      <nav class="font-ui text-sm flex items-center gap-4">
        <a href="index.html" class="hover:text-aggieGold">Home</a>
        <a href="leaderboard.html" class="hover:text-aggieGold">Leaderboard</a>
        <div class="relative group">
          <button id="userMenuBtn" class="rounded-lg px-3 py-1.5 bg-white/10 hover:bg-white/20">Account ▾</button>
          <div id="userMenu" class="hidden absolute right-0 mt-2 w-40 bg-white text-ink rounded-xl shadow-soft overflow-hidden">
            <a href="account.html" class="block px-4 py-2 hover:bg-aggieBg">Settings</a>
            <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-aggieBg">Log out</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Page -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <!-- Filters / Info -->
    <section class="mb-6">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-end justify-between">
        <div>
          <h2 class="font-heading text-xl sm:text-2xl text-aggieBlue">Plan your points</h2>
          <p class="text-slate text-sm mt-1">This week, this month (excluding this week), and all upcoming events. Past events are hidden.</p>
        </div>
        <div class="flex items-center gap-2">
          <input id="searchInput" type="search" placeholder="Search events…"
                 class="font-ui w-64 rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-aggieGold" />
          <select id="sortSelect" class="font-ui rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-aggieGold">
            <option value="soonest">Sort: Soonest</option>
            <option value="points">Sort: Points (desc)</option>
            <option value="title">Sort: Title (A–Z)</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Sections -->
    <section id="thisWeek" class="mb-10">
      <h3 class="font-heading text-lg text-aggieBlue mb-3">This Week</h3>
      <div id="listThisWeek" class="grid gap-4 md:grid-cols-2">
        <!-- Cards injected here -->
      </div>
      <p id="emptyThisWeek" class="hidden text-slate text-sm">No events this week yet.</p>
    </section>

    <section id="thisMonth" class="mb-10">
      <h3 class="font-heading text-lg text-aggieBlue mb-3">This Month (excluding this week)</h3>
      <div id="listThisMonth" class="grid gap-4 md:grid-cols-2">
        <!-- Cards injected here -->
      </div>
      <p id="emptyThisMonth" class="hidden text-slate text-sm">No more events this month.</p>
    </section>

    <section id="upcoming" class="mb-16">
      <h3 class="font-heading text-lg text-aggieBlue mb-3">All Upcoming</h3>
      <div id="listUpcoming" class="grid gap-4 md:grid-cols-2">
        <!-- Cards injected here -->
      </div>
      <p id="emptyUpcoming" class="hidden text-slate text-sm">Nothing scheduled yet. Check back soon!</p>
    </section>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-200">
    <div class="mx-auto max-w-6xl px-4 py-6 text-sm text-slate font-ui">
      © <span id="year"></span> Aggie Points
    </div>
  </footer>

  <!-- Supabase + App config -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>

  <script>
  (function () {
    const tz = 'America/Los_Angeles';

    // UI elements
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userMenu = document.getElementById('userMenu');
    const logoutBtn = document.getElementById('logoutBtn');
    const yearEl = document.getElementById('year');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');

    const listThisWeek = document.getElementById('listThisWeek');
    const listThisMonth = document.getElementById('listThisMonth');
    const listUpcoming = document.getElementById('listUpcoming');
    const emptyThisWeek = document.getElementById('emptyThisWeek');
    const emptyThisMonth = document.getElementById('emptyThisMonth');
    const emptyUpcoming = document.getElementById('emptyUpcoming');

    yearEl.textContent = new Date().getFullYear();

    // Simple menu toggle
    userMenuBtn?.addEventListener('click', () => userMenu.classList.toggle('hidden'));
    document.addEventListener('click', (e) => {
      if (!userMenuBtn.contains(e.target) && !userMenu.contains(e.target)) {
        userMenu.classList.add('hidden');
      }
    });

    // Auth guard
    async function ensureAuthed() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return null;
      }
      return session;
    }

    logoutBtn?.addEventListener('click', async () => {
      await sb.auth.signOut();
      window.location.href = 'login.html';
    });

    // Formatting helpers
    function fmtRange(startIso, endIso) {
      const s = new Date(startIso);
      const e = new Date(endIso);
      const sameDay = s.toDateString() === e.toDateString();
      const dtfDate = new Intl.DateTimeFormat('en-US', { timeZone: tz, weekday: 'short', month: 'short', day: 'numeric' });
      const dtfTime = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit' });
      if (sameDay) {
        return `${dtfDate.format(s)} · ${dtfTime.format(s)}–${dtfTime.format(e)} PT`;
      }
      const dtfDateTime = new Intl.DateTimeFormat('en-US', { timeZone: tz, month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
      return `${dtfDateTime.format(s)} – ${dtfDateTime.format(e)} PT`;
    }

    function inProgress(endIso) {
      return new Date(endIso).getTime() >= Date.now();
    }

    function card(event) {
      const { id, title, start_ts, end_ts, location, points } = event;
      const when = fmtRange(start_ts, end_ts);
      const badge = points ? `<span class="ml-2 inline-flex items-center rounded-full bg-aggieGold/20 px-2 py-0.5 text-xs font-ui text-aggieBlue">+${points} pts</span>` : '';
      return `
        <article class="rounded-2xl bg-white shadow-soft border border-gray-100 p-4 flex flex-col justify-between">
          <div>
            <h4 class="font-heading text-lg text-aggieBlue">${escapeHtml(title)} ${badge}</h4>
            <p class="mt-1 text-sm text-slate">${escapeHtml(location || 'TBA')}</p>
            <p class="mt-2 font-ui text-sm">${when}</p>
          </div>
          <div class="mt-4">
            <a href="index.html#today" class="inline-flex items-center gap-2 rounded-xl bg-aggieBlue px-3 py-2 text-white font-ui hover:bg-aggieBlue/90">
              View / Check-in on Home
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
        </article>
      `;
    }

    function escapeHtml(s) {
      return (s ?? '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Fetch: single view for low throttling
    let rawEvents = [];
    async function loadEvents() {
      // Ensure session because RLS requires it
      const session = await ensureAuthed();
      if (!session) return;

      // Prefer the combined view 'events_catalog' (created from our SQL patch).
      // Fallback: query base 'events' and bucket on client (works but not ideal).
      let { data, error } = await sb
        .from('events_catalog')
        .select('*')
        .order('start_ts', { ascending: true });

      if (error && error.code === '42P01') {
        // view not found — fallback
        ({ data, error } = await sb
          .from('events')
          .select('id, title, start_ts, end_ts, location, points, status')
          .order('start_ts', { ascending: true }));
      }
      if (error) {
        console.error(error);
        showError('Could not load events. Please try again.');
        return;
      }

      // Filter out any past events defensively (server should already do this)
      rawEvents = (data || []).filter(e => e?.end_ts && inProgress(e.end_ts));

      render();
    }

    function bucketize(events) {
      // Build PT week & month windows
      const now = new Date();
      const localNow = new Date(now.toLocaleString('en-US', { timeZone: tz }));

      // Monday-start week in PT
      const day = localNow.getDay(); // Sun 0 .. Sat 6
      const daysFromMonday = (day + 6) % 7; // Mon 0 .. Sun 6
      const weekStartLocal = new Date(localNow);
      weekStartLocal.setDate(localNow.getDate() - daysFromMonday);
      weekStartLocal.setHours(0,0,0,0);

      const weekEndLocal = new Date(weekStartLocal);
      weekEndLocal.setDate(weekStartLocal.getDate() + 7);

      // Month window
      const monthStartLocal = new Date(localNow.getFullYear(), localNow.getMonth(), 1);
      const monthEndLocal = new Date(localNow.getFullYear(), localNow.getMonth()+1, 1);

      // Convert local PT window bounds to UTC ISO for comparing UTC timestamps
      const weekStart = new Date(weekStartLocal.toLocaleString('en-US', { timeZone: 'UTC' })).toISOString();
      const weekEnd   = new Date(weekEndLocal.toLocaleString('en-US', { timeZone: 'UTC' })).toISOString();
      const monthStart= new Date(monthStartLocal.toLocaleString('en-US', { timeZone: 'UTC' })).toISOString();
      const monthEnd  = new Date(monthEndLocal.toLocaleString('en-US', { timeZone: 'UTC' })).toISOString();

      const thisWeek = [];
      const thisMonthExclWeek = [];
      const upcoming = [];

      for (const e of events) {
        if (!inProgress(e.end_ts)) continue; // extra safety
        const s = e.start_ts;

        if (s >= weekStart && s < weekEnd) {
          thisWeek.push(e);
        } else if (s >= monthStart && s < monthEnd) {
          thisMonthExclWeek.push(e);
        } else {
          upcoming.push(e);
        }
      }
      return { thisWeek, thisMonthExclWeek, upcoming };
    }

    function sortEvents(arr, mode) {
      const list = [...arr];
      if (mode === 'points') {
        list.sort((a,b) => (b.points||0) - (a.points||0) || new Date(a.start_ts) - new Date(b.start_ts));
      } else if (mode === 'title') {
        list.sort((a,b) => (a.title||'').localeCompare(b.title||''));
      } else {
        // soonest
        list.sort((a,b) => new Date(a.start_ts) - new Date(b.start_ts));
      }
      return list;
    }

    function applySearch(arr, q) {
      if (!q) return arr;
      const term = q.trim().toLowerCase();
      return arr.filter(e =>
        (e.title||'').toLowerCase().includes(term) ||
        (e.location||'').toLowerCase().includes(term)
      );
    }

    function render() {
      const q = searchInput.value;
      const mode = sortSelect.value;

      const { thisWeek, thisMonthExclWeek, upcoming } = bucketize(rawEvents);

      const w = sortEvents(applySearch(thisWeek, q), mode);
      const m = sortEvents(applySearch(thisMonthExclWeek, q), mode);
      const u = sortEvents(applySearch(upcoming, q), mode);

      listThisWeek.innerHTML = w.map(card).join('');
      listThisMonth.innerHTML = m.map(card).join('');
      listUpcoming.innerHTML = u.map(card).join('');

      emptyThisWeek.classList.toggle('hidden', w.length > 0);
      emptyThisMonth.classList.toggle('hidden', m.length > 0);
      emptyUpcoming.classList.toggle('hidden', u.length > 0);
    }

    function showError(msg) {
      listThisWeek.innerHTML = '';
      listThisMonth.innerHTML = '';
      listUpcoming.innerHTML = '';
      emptyThisWeek.textContent = msg;
      emptyThisMonth.textContent = msg;
      emptyUpcoming.textContent = msg;
      emptyThisWeek.classList.remove('hidden');
      emptyThisMonth.classList.remove('hidden');
      emptyUpcoming.classList.remove('hidden');
    }

    // Events
    searchInput.addEventListener('input', render);
    sortSelect.addEventListener('change', render);

    // Boot
    loadEvents();
  })();
  </script>
</body>
</html>
