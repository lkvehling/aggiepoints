<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggie Points ‚Äî Home</title>
  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0b0f1a; --panel:#121826; --muted:#9aa6b2; --fg:#e6edf3; --accent:#6bb6ff; --ok:#22c55e; --warn:#facc15; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f1a,#0e1424 40%,#0b0f1a);color:var(--fg)}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;background:rgba(18,24,38,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1e293b}
    .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
    .brand{font-weight:700;letter-spacing:.3px}
    .spacer{flex:1}
    .menu a{margin:0 8px;font-weight:600;color:#cbd5e1}
    .card{background:linear-gradient(180deg,#0f172a 0%, #0b1224 100%);border:1px solid #1e293b;border-radius:16px;padding:16px}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .welcome{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .welcome h1{margin:0;font-size:28px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .stat{display:flex;flex-direction:column;gap:6px}
    .stat .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .stat .value{font-size:28px;font-weight:700}
    .events-list{display:flex;flex-direction:column;gap:12px}
    .event{display:flex;align-items:center;justify-content:space-between;gap:12px;border:1px solid #1e293b;border-radius:12px;padding:12px}
    .event h4{margin:0 0 6px 0}
    .kicker{font-size:12px;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:linear-gradient(180deg,#1e293b,#0f172a);border-color:#334155}
    .btn.ghost{background:transparent}
    .pill{padding:4px 8px;border-radius:999px;background:#0b1224;border:1px solid #1e293b;color:#cbd5e1;font-size:12px}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px}
    .right{margin-left:auto}
    .hidden{display:none}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;right:0;top:100%;margin-top:8px;background:#0f172a;border:1px solid #1e293b;border-radius:12px;padding:8px;min-width:180px;display:none}
    .dropdown.open .dropdown-menu{display:block}
    .dropdown-menu a,.dropdown-menu button{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;color:#cbd5e1;background:transparent;border:none;cursor:pointer}
    .dropdown-menu a:hover,.dropdown-menu button:hover{background:#0b1224}
    .skeleton{background:linear-gradient(90deg,#0e1424 25%,#0f1628 37%,#0e1424 63%);background-size:400% 100%;animation:shimmer 1.4s ease infinite;border-radius:8px}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">üèÖ Aggie Points</div>
      <div class="menu">
        <a href="index.html" aria-current="page">Home</a>
        <a href="events.html">All Events</a>
        <a href="leaderboard.html">Leaderboard</a>
      </div>
      <div class="spacer"></div>
      <div class="dropdown" id="accountDropdown">
        <button class="btn" id="accountBtn">Account ‚ñæ</button>
        <div class="dropdown-menu">
          <a href="#" id="accountSettings">Account Settings</a>
          <button id="logoutBtn">Log out</button>
        </div>
      </div>
      <a href="login.html" class="btn primary" id="loginBtn">Log in</a>
    </nav>
  </header>

  <main class="container">
    <section class="welcome card">
      <div>
        <div class="kicker">Welcome</div>
        <h1 id="welcomeHeadline">WELCOME TO AGGIE POINTS</h1>
        <div class="muted" id="welcomeSub">Track your progress and check in to today's events.</div>
      </div>
      <div class="row">
        <span id="authStatus" class="pill">Not signed in</span>
      </div>
    </section>

    <section class="grid" style="margin-bottom:16px">
      <div class="col-4 card">
        <div class="stat"><span class="label">Points</span>
          <div id="pointsValue" class="value skeleton" style="height:36px;width:120px"></div>
        </div>
      </div>
      <div class="col-4 card">
        <div class="stat"><span class="label">Rank</span>
          <div id="rankValue" class="value skeleton" style="height:36px;width:120px"></div>
        </div>
      </div>
      <div class="col-4 card">
        <div class="stat"><span class="label">Team</span>
          <div id="teamValue" class="value skeleton" style="height:36px;width:160px"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="margin-bottom:12px">
        <h2 style="margin:0">Today's Events</h2>
        <span class="pill right" id="todayPill">‚Äî</span>
      </div>
      <div id="eventsEmpty" class="muted">No events today.</div>
      <div id="eventsList" class="events-list"></div>
    </section>
  </main>

  <!-- Your Supabase project config (already in your repo) -->
  <script src="auth-config.js"></script>
  <script>
    // ======= Auth / UI helpers =======
    const accountBtn = document.getElementById('accountBtn');
    const accountDropdown = document.getElementById('accountDropdown');
    const loginBtn = document.getElementById('loginBtn');
    accountBtn?.addEventListener('click', () => accountDropdown.classList.toggle('open'));
    document.addEventListener('click', (e) => {
      if (!accountDropdown.contains(e.target)) accountDropdown.classList.remove('open');
    });

    const $ = (id) => document.getElementById(id);
    const setLoading = () => {
      ['pointsValue','rankValue','teamValue'].forEach(id => {
        $(id).classList.add('skeleton'); $(id).textContent = '';
      });
      $('eventsList').innerHTML = '';
      $('eventsEmpty').classList.remove('hidden');
    };

    const fmtTime = (d) => new Date(d).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });
    const fmtDate = (d) => new Date(d).toLocaleDateString([], { month:'short', day:'numeric' });

    // ======= Data fetchers =======
    async function ensureAuth() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        $('authStatus').textContent = 'Not signed in';
        loginBtn?.classList.remove('hidden');
        accountDropdown?.classList.add('hidden');
        $('welcomeSub').textContent = 'Please log in to see your points and events.';
        return null;
      }
      $('authStatus').textContent = `Signed in as ${user.email}`;
      loginBtn?.classList.add('hidden');
      accountDropdown?.classList.remove('hidden');
      return user;
    }

    async function loadProfileAndStats(user) {
      // 1) Profile
      const { data: profile, error: pErr } = await sb
        .from('profiles')
        .select('id, full_name, team, points')
        .eq('id', user.id)
        .single();
      if (pErr) throw new Error('profiles: ' + pErr.message);

      $('welcomeHeadline').textContent = profile?.full_name ? `WELCOME, ${profile.full_name.toUpperCase()}` : 'WELCOME TO AGGIE POINTS';
      $('teamValue').textContent = profile?.team || '‚Äî';
      $('teamValue').classList.remove('skeleton');

      const points = Number(profile?.points || 0);
      $('pointsValue').textContent = points.toLocaleString();
      $('pointsValue').classList.remove('skeleton');

      // 2) Rank = count of users with points greater than mine + 1
      const { count, error: rErr } = await sb
        .from('profiles')
        .select('*', { count: 'exact', head: true })
        .gt('points', points);
      if (rErr) throw new Error('rank: ' + rErr.message);
      $('rankValue').textContent = ((count || 0) + 1).toString();
      $('rankValue').classList.remove('skeleton');
    }

    function dayBoundsLocalToUTC(date = new Date()) {
      // Convert the user's local day to UTC window [start,end)
      const start = new Date(date);
      start.setHours(0,0,0,0);
      const end = new Date(date);
      end.setHours(23,59,59,999);
      return { start: start.toISOString(), end: end.toISOString(), label: date.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' }) };
    }

    async function loadTodaysEvents(user) {
      const { start, end, label } = dayBoundsLocalToUTC(new Date());
      $('todayPill').textContent = label;

      const { data: events, error: eErr } = await sb
        .from('events')
        .select('id, title, location, start_time, end_time, points_awarded, is_active')
        .gte('start_time', start)
        .lte('start_time', end)
        .eq('is_active', true)
        .order('start_time', { ascending: true });
      if (eErr) throw new Error('events: ' + eErr.message);

      const list = $('eventsList');
      list.innerHTML = '';

      if (!events || events.length === 0) {
        $('eventsEmpty').classList.remove('hidden');
        return;
      }
      $('eventsEmpty').classList.add('hidden');

      // Preload user's existing check-ins to disable buttons
      const { data: myChecks } = await sb
        .from('checkins')
        .select('event_id')
        .eq('user_id', user.id)
        .gte('created_at', start)
        .lte('created_at', end);
      const checkedMap = new Set((myChecks||[]).map(c => c.event_id));

      for (const ev of events) {
        const isChecked = checkedMap.has(ev.id);
        const card = document.createElement('div');
        card.className = 'event';
        card.innerHTML = `
          <div>
            <h4>${ev.title || 'Event'}</h4>
            <div class="muted">${fmtDate(ev.start_time)} ¬∑ ${fmtTime(ev.start_time)}‚Äì${fmtTime(ev.end_time || ev.start_time)} ¬∑ ${ev.location || ''}</div>
          </div>
          <div class="row">
            <span class="pill">${ev.points_awarded ?? 0} pts</span>
            <button class="btn primary" ${isChecked ? 'disabled' : ''} data-ev="${ev.id}">
              ${isChecked ? 'Checked in' : 'Check in'}
            </button>
          </div>`;
        card.querySelector('button')?.addEventListener('click', () => checkIn(ev.id));
        list.appendChild(card);
      }
    }

    async function checkIn(eventId) {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) return window.location.href = 'login.html';
      const { error } = await sb.from('checkins').insert({ user_id: user.id, event_id: eventId });
      if (error) {
        alert('Check-in failed: ' + error.message);
        return;
      }
      // Optimistic refresh
      loadPage();
    }

    async function loadPage() {
      try {
        setLoading();
        const user = await ensureAuth();
        if (!user) return; // not signed in
        await loadProfileAndStats(user);
        await loadTodaysEvents(user);
      } catch (err) {
        console.error(err);
        $('welcomeSub').innerHTML = `<span class="danger">${err.message}</span>`;
      }
    }

    // Handle auth state changes (e.g., after login redirect)
    sb.auth.onAuthStateChange((_evt, session) => {
      if (session?.user) loadPage();
    });

    // Kick off
    loadPage();

    // Buttons
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      await sb.auth.signOut();
      window.location.href = 'login.html';
    });
    document.getElementById('accountSettings')?.addEventListener('click', () => alert('Coming soon'));
  </script>
</body>
</html>
