<!DOCTYPE html>
<html>
<head>
  <title>Aggie Points Check-In</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    .event-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .event-card h3 {
      margin: 0 0 10px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #0056b3;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: gray;
      cursor: not-allowed;
    }
    #formContainer {
      margin-top: 30px;
      display: none;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: none;
    }
  </style>
</head>
<body>
  <h2>Aggie Points Check-In</h2>
  <div id="events"></div>
  <div id="formContainer">
    <h3 id="formTitle"></h3>
    <iframe id="jotformFrame"></iframe>
  </div>

  <script>
    const sheetUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKTWEbVoSyYdw6wVVbIuql9hb_NoAt7jcLoFfKI2PCz9UA3z8PJwkrWcFDjbEbGj9FVb_R_6r2Y2es/pub?output=csv";

    function parseLocalDateTime(dt) {
      const [datePart, timePart] = dt.split("T");
      const [year, month, day] = datePart.split("-").map(Number);
      const [hour, min, sec] = timePart.split(":").map(Number);
      return new Date(year, month - 1, day, hour, min, sec);
    }

    async function getTodayEvents() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim());
      const now = new Date();

      return rows.slice(1).map(r => ({
        name: r[headers.indexOf("Event Name")],
        latMin: parseFloat(r[headers.indexOf("Lat Min")]),
        latMax: parseFloat(r[headers.indexOf("Lat Max")]),
        lngMin: parseFloat(r[headers.indexOf("Lng Min")]),
        lngMax: parseFloat(r[headers.indexOf("Lng Max")]),
        start: parseLocalDateTime(r[headers.indexOf("Start Time")]),
        end: parseLocalDateTime(r[headers.indexOf("End Time")])
      })).filter(ev => now >= ev.start && now <= ev.end);
    }

    function inBox(lat, lng, ev) {
      return lat >= ev.latMin &&
             lat <= ev.latMax &&
             lng >= ev.lngMin &&
             lng <= ev.lngMax;
    }

    function renderEvents(events) {
      const container = document.getElementById("events");
      if (events.length === 0) {
        container.innerHTML = "<p>No events scheduled right now.</p>";
        return;
      }
      container.innerHTML = "";
      events.forEach(ev => {
        const card = document.createElement("div");
        card.className = "event-card";

        const title = document.createElement("h3");
        title.textContent = ev.name;
        card.appendChild(title);

        const time = document.createElement("p");
        time.textContent = `${ev.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${ev.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        card.appendChild(time);

        const btn = document.createElement("button");
        btn.textContent = "Check In";
        if (localStorage.getItem("submitted_" + ev.name)) {
          btn.disabled = true;
          btn.textContent = "Already Checked In";
        }
        btn.onclick = () => handleCheckIn(ev, btn);
        card.appendChild(btn);

        container.appendChild(card);
      });
    }

    function handleCheckIn(event, button) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (!inBox(lat, lng, event)) {
          alert("❌ You are not at the correct location for this event.");
          return;
        }

        // Passed checks
        document.getElementById("formTitle").innerText =
          `Checking into ${event.name}`;
        const jotformUrl =
          `https://form.jotform.com/252508114551046?eventName=${encodeURIComponent(event.name)}&eventStart=${event.start.toISOString()}&eventEnd=${event.end.toISOString()}`;
        document.getElementById("jotformFrame").src = jotformUrl;
        document.getElementById("formContainer").style.display = "block";
      }, () => {
        alert("Unable to get location. Please enable GPS.");
      });
    }

    (async () => {
      const events = await getTodayEvents();
      renderEvents(events);
    })();
  </script>
</body>
</html>
