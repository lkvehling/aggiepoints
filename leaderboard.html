<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aggie Points — Leaderboard</title>

  <!-- Fonts (Raleway = headings, Montserrat = UI/body, Merriweather optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aggieBlue: "#022851",
            aggieGold: "#FFBF00",
            aggieBg: "#F7F7F7",
            ink: "#333333",
          },
          fontFamily: {
            heading: ["Raleway", "Helvetica Neue", "Arial", "sans-serif"],
            ui: ["Montserrat", "Helvetica Neue", "Arial", "sans-serif"],
            serif: ["Merriweather", "Georgia", "serif"],
          }
        }
      }
    }
  </script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    @media (max-width: 420px) {
      .td-tight td { padding-top: 0.35rem; padding-bottom: 0.35rem; }
    }
  </style>
</head>
<body class="bg-aggieBg text-ink font-ui">
  <!-- Top bar (kept minimal + on-theme) -->
  <header class="sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-aggieBlue/10">
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3 flex items-center gap-2">
      <h1 class="font-heading font-extrabold tracking-wide text-aggieBlue text-lg sm:text-xl">
        Leaderboard
      </h1>
      <nav class="ml-auto hidden sm:flex items-center gap-4">
        <a href="index.html" class="text-sm hover:underline underline-offset-2 text-aggieBlue">Home</a>
        <a href="events.html" class="text-sm hover:underline underline-offset-2 text-aggieBlue">Events</a>
        <a href="settings.html" class="text-sm hover:underline underline-offset-2 text-aggieBlue">Settings</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 sm:px-4 py-4">
    <!-- Filters -->
    <section class="mb-3">
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
        <label class="sm:col-span-2">
          <span class="sr-only">Search</span>
          <input id="searchInput" type="text" placeholder="Search athlete or team…"
                 class="w-full rounded-xl border border-aggieBlue/15 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-aggieGold" />
        </label>

        <label class="sm:col-span-2">
          <span class="sr-only">Team</span>
          <select id="teamFilter"
                  class="w-full rounded-xl border border-aggieBlue/15 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-aggieGold">
            <option value="">All teams</option>
          </select>
        </label>

        <div class="sm:col-span-1">
          <div class="bg-white border border-aggieBlue/15 rounded-xl p-1 flex">
            <button id="viewAll" class="flex-1 text-xs sm:text-sm px-2 py-1 rounded-lg bg-aggieBlue text-white">All</button>
            <button id="viewParticipation" class="flex-1 text-xs sm:text-sm px-2 py-1 rounded-lg">Participation</button>
            <button id="viewAverage" class="flex-1 text-xs sm:text-sm px-2 py-1 rounded-lg">Average</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Table (desktop) -->
    <section class="bg-white border border-aggieBlue/15 rounded-2xl overflow-hidden">
      <div class="hidden sm:block overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-aggieBlue text-white sticky top-[57px] sm:top-[61px] z-10">
            <tr>
              <th class="text-left font-semibold px-3 py-2"># Part</th>
              <th class="text-left font-semibold px-3 py-2">Athlete</th>
              <th class="text-left font-semibold px-3 py-2">Team</th>
              <th class="text-right font-semibold px-3 py-2">Events</th>
              <th class="text-right font-semibold px-3 py-2">Points</th>
              <th class="text-right font-semibold px-3 py-2">Avg/Ev</th>
              <th class="text-right font-semibold px-3 py-2"># Avg</th>
              <th class="text-right font-semibold px-3 py-2">Δ Rank</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-aggieBlue/10 td-tight"></tbody>
        </table>
      </div>

      <!-- List (mobile) -->
      <div id="mobileList" class="sm:hidden divide-y divide-aggieBlue/10"></div>

      <!-- Pagination -->
      <div class="px-3 py-2 flex items-center justify-between bg-aggieBg">
        <div id="countLabel" class="text-xs">Showing 0</div>
        <button id="loadMoreBtn" class="text-sm px-3 py-1 rounded-lg border border-aggieBlue/20 bg-white hover:bg-aggieBg">
          Load more
        </button>
      </div>
    </section>

    <p class="mt-2 text-xs">
      Δ Rank = (# Avg) − (# Part). Lower is better. ▲ better Avg rank; ▼ worse Avg rank.
    </p>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>

  <script>
    // ===== Field map: adjust here if your view columns differ =====
    const FIELD_MAP = {
      id: "id",
      name: "full_name",
      team: "team_name",
      total_points: "total_points",
      events_attended: "events_attended",
      avg_points: "avg_points_per_event", // if missing, we compute it
    };

    // ===== State =====
    const PAGE_SIZE = 50;
    let allAthletes = [];
    let filtered = [];
    let renderedCount = 0;
    let currentView = "all";

    // ===== UI =====
    const searchInput = document.getElementById('searchInput');
    const teamFilter = document.getElementById('teamFilter');
    const viewAllBtn = document.getElementById('viewAll');
    const viewPartBtn = document.getElementById('viewParticipation');
    const viewAvgBtn = document.getElementById('viewAverage');
    const tableBody = document.getElementById('tableBody');
    const mobileList = document.getElementById('mobileList');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const countLabel = document.getElementById('countLabel');

    // ===== Helpers =====
    const toFixed1 = (x) => (x ?? 0).toFixed(1);

    function computeRanks(items, key, tiebreakers = []) {
      const arr = [...items].sort((a, b) => {
        const d = (b[key] ?? 0) - (a[key] ?? 0);
        if (d !== 0) return d;
        for (const tb of tiebreakers) {
          const dd = (b[tb] ?? 0) - (a[tb] ?? 0);
          if (dd !== 0) return dd;
        }
        return a.name.localeCompare(b.name);
      });
      const rankMap = new Map();
      let rank = 1;
      for (let i = 0; i < arr.length; i++) {
        if (i > 0) {
          const prev = arr[i - 1], cur = arr[i];
          if ((cur[key] ?? 0) !== (prev[key] ?? 0)) rank = i + 1;
        }
        rankMap.set(arr[i].id, rank);
      }
      return rankMap;
    }

    function deltaArrow(delta) {
      if (delta < 0) return `▲ ${Math.abs(delta)}`;
      if (delta > 0) return `▼ ${Math.abs(delta)}`;
      return "—";
    }

    function clearRender() {
      tableBody.innerHTML = "";
      mobileList.innerHTML = "";
      renderedCount = 0;
    }

    function sortForView() {
      if (currentView === "participation") {
        filtered.sort((a, b) =>
          (a.rank_participation - b.rank_participation) ||
          (a.rank_average - b.rank_average)
        );
      } else if (currentView === "average") {
        filtered.sort((a, b) =>
          (a.rank_average - b.rank_average) ||
          (a.rank_participation - b.rank_participation)
        );
      } else {
        filtered.sort((a, b) =>
          (a.rank_participation - b.rank_participation) ||
          (a.rank_average - b.rank_average)
        );
      }
    }

    function applyFiltersAndView() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const team = teamFilter.value || "";

      filtered = allAthletes.filter(a => {
        const matchQ = !q || a.name?.toLowerCase().includes(q) || a.team?.toLowerCase().includes(q);
        const matchT = !team || a.team === team;
        return matchQ && matchT;
      });

      sortForView();
      clearRender();
      renderMore();
      updateCount();
    }

    function updateCount() {
      countLabel.textContent = `Showing ${Math.min(renderedCount, filtered.length)} of ${filtered.length}`;
      loadMoreBtn.style.display = renderedCount < filtered.length ? "inline-block" : "none";
    }

    function renderRow(a) {
      // Desktop row
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2">${a.rank_participation}</td>
        <td class="px-3 py-2 font-semibold">${a.name || "—"}</td>
        <td class="px-3 py-2">${a.team || "—"}</td>
        <td class="px-3 py-2 text-right">${a.events_attended ?? 0}</td>
        <td class="px-3 py-2 text-right">${a.total_points ?? 0}</td>
        <td class="px-3 py-2 text-right">${toFixed1(a.avg_points)}</td>
        <td class="px-3 py-2 text-right">${a.rank_average}</td>
        <td class="px-3 py-2 text-right">${deltaArrow(a.delta_rank)}</td>
      `;
      tableBody.appendChild(tr);

      // Mobile card
      const card = document.createElement('div');
      card.className = "px-3 py-2";
      card.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="min-w-0">
            <div class="text-xs text-ink"># Part ${a.rank_participation} • # Avg ${a.rank_average}</div>
            <div class="font-semibold truncate">${a.name || "—"}</div>
            <div class="text-xs truncate">${a.team || "—"}</div>
          </div>
          <div class="text-right ml-2">
            <div class="text-xs">${deltaArrow(a.delta_rank)}</div>
            <div class="text-[11px]">Δ Rank</div>
          </div>
        </div>
        <div class="mt-1 grid grid-cols-3 gap-1 text-sm">
          <div class="bg-aggieBg rounded-lg px-2 py-1 text-center">
            <div class="font-semibold">${a.events_attended ?? 0}</div>
            <div class="text-[11px]">Events</div>
          </div>
          <div class="bg-aggieBg rounded-lg px-2 py-1 text-center">
            <div class="font-semibold">${a.total_points ?? 0}</div>
            <div class="text-[11px]">Points</div>
          </div>
          <div class="bg-aggieBg rounded-lg px-2 py-1 text-center">
            <div class="font-semibold">${toFixed1(a.avg_points)}</div>
            <div class="text-[11px]">Avg/Ev</div>
          </div>
        </div>
      `;
      mobileList.appendChild(card);
    }

    function renderMore() {
      const next = filtered.slice(renderedCount, renderedCount + PAGE_SIZE);
      next.forEach(renderRow);
      renderedCount += next.length;
      updateCount();
    }

    function setView(v) {
      currentView = v;
      [viewAllBtn, viewPartBtn, viewAvgBtn].forEach(b => b.classList.remove("bg-aggieBlue","text-white"));
      if (v === "all") viewAllBtn.classList.add("bg-aggieBlue","text-white");
      if (v === "participation") viewPartBtn.classList.add("bg-aggieBlue","text-white");
      if (v === "average") viewAvgBtn.classList.add("bg-aggieBlue","text-white");
      applyFiltersAndView();
    }

    // ===== Data =====
    async function fetchLeaderboard() {
      const fields = [
        FIELD_MAP.id,
        FIELD_MAP.name,
        FIELD_MAP.team,
        FIELD_MAP.total_points,
        FIELD_MAP.events_attended,
        FIELD_MAP.avg_points
      ].filter(Boolean).join(",");

      const { data, error } = await sb
        .from('profiles')
        .select(fields)
        .neq(FIELD_MAP.name, null);

      if (error) {
        console.error(error);
        alert("Failed to load leaderboard.");
        return;
      }

      const rows = (data || []).map(r => {
        const id = r[FIELD_MAP.id];
        const name = r[FIELD_MAP.name];
        const team = r[FIELD_MAP.team] ?? "";
        const total_points = Number(r[FIELD_MAP.total_points] ?? 0);
        const events_attended = Number(r[FIELD_MAP.events_attended] ?? 0);
        const avg_points = r[FIELD_MAP.avg_points] != null
          ? Number(r[FIELD_MAP.avg_points])
          : (events_attended > 0 ? total_points / events_attended : 0);
        return { id, name, team, total_points, events_attended, avg_points };
      });

      const partRanks = computeRanks(rows, "events_attended", ["total_points"]);
      const avgRanks  = computeRanks(rows, "avg_points", ["total_points","events_attended"]);

      allAthletes = rows.map(a => {
        const rp = partRanks.get(a.id) ?? 9999;
        const ra = avgRanks.get(a.id) ?? 9999;
        return { ...a, rank_participation: rp, rank_average: ra, delta_rank: ra - rp };
      });

      // Team filter options
      const teams = Array.from(new Set(allAthletes.map(a => a.team).filter(Boolean))).sort();
      for (const t of teams) {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        teamFilter.appendChild(opt);
      }

      applyFiltersAndView();
    }

    // ===== Events =====
    searchInput.addEventListener('input', applyFiltersAndView);
    teamFilter.addEventListener('change', applyFiltersAndView);
    loadMoreBtn.addEventListener('click', renderMore);
    viewAllBtn.addEventListener('click', () => setView('all'));
    viewPartBtn.addEventListener('click', () => setView('participation'));
    viewAvgBtn.addEventListener('click', () => setView('average'));

    // Start
    fetchLeaderboard();
  </script>
</body>
</html>
