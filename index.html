<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aggie Points Check-In</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header, footer { margin-bottom: 20px; }
    .event { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .msg { color: green; margin-top: 5px; }
    button { cursor: pointer; }
  </style>
</head>
<body>

  <header>
    <h1>Aggie Points Check-In</h1>
    <div id="userStatus">Checking login...</div>
  </header>

  <main>
    <h2>Today's Events</h2>
    <div id="events">Loading events...</div>
  </main>

  <footer>
    <p>UC Davis Women's Water Polo Team</p>
  </footer>

  <script>
    // -------------------------------
    // 1Ô∏è‚É£ Initialize Supabase first
    // -------------------------------
    const SUPABASE_URL = "https://gtnptxnkminqmjnnfxie.supabase.co";
    const SUPABASE_KEY = "YOUR_ANON_KEY_HERE"; // replace with your anon key
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    // -------------------------------
    // 2Ô∏è‚É£ Get logged-in user or redirect
    // -------------------------------
    async function getUser() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      if (error || !user) {
        window.location.href = "login"; // redirect if not logged in
        return null;
      }
      currentUser = user;
      document.getElementById("userStatus").textContent = `Logged in as: ${user.email}`;
      return user;
    }

    // -------------------------------
    // 3Ô∏è‚É£ Load today‚Äôs events
    // -------------------------------
    async function loadEvents() {
      const user = await getUser();
      if (!user) return;

      const todayStart = new Date();
      todayStart.setHours(0,0,0,0);
      const todayEnd = new Date();
      todayEnd.setHours(23,59,59,999);

      const { data: events, error } = await supabaseClient
        .from("events")
        .select("*")
        .gte("start_time", todayStart.toISOString())
        .lte("end_time", todayEnd.toISOString())
        .order("start_time", { ascending: true });

      const container = document.getElementById("events");
      container.innerHTML = "";

      if (error) {
        console.error(error);
        container.innerHTML = "<p>Failed to load events.</p>";
        return;
      }

      if (!events || events.length === 0) {
        container.innerHTML = "<p>No events scheduled for today.</p>";
        return;
      }

      events.forEach(event => {
        const div = document.createElement("div");
        div.classList.add("event");
        div.innerHTML = `
          <h3>${event.name}</h3>
          <p>${event.location || ""}</p>
          <p>${new Date(event.start_time).toLocaleString()} - ${new Date(event.end_time).toLocaleString()}</p>
          <p>Points: ${event.points || 0}</p>
          <button onclick="checkIn('${event.id}')">Check In</button>
          <p id="msg-${event.id}" class="msg"></p>
        `;
        container.appendChild(div);
      });
    }

    // -------------------------------
    // 4Ô∏è‚É£ Check-in logic
    // -------------------------------
    async function checkIn(eventId) {
      if (!currentUser) {
        alert("You must be logged in to check in!");
        return;
      }

      const { error } = await supabaseClient
        .from("checkins")
        .insert([{ user_id: currentUser.id, event_id: eventId }]);

      const msg = document.getElementById(`msg-${eventId}`);

      if (error) {
        if (error.message.includes("duplicate")) {
          msg.textContent = "‚úÖ Already checked in!";
        } else {
          msg.textContent = "‚ùå Error: " + error.message;
        }
      } else {
        msg.textContent = "üéâ Successfully checked in!";
      }
    }

    // -------------------------------
    // 5Ô∏è‚É£ Log out user on page close/refresh
    // -------------------------------
    window.addEventListener("beforeunload", async () => {
      if (currentUser) {
        await supabaseClient.auth.signOut();
        currentUser = null;
      }
    });

    // -------------------------------
    // 6Ô∏è‚É£ Initialize page
    // -------------------------------
    loadEvents();
  </script>

</body>
</html>
