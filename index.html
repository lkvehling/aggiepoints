<!DOCTYPE html>
<html>
<head>
  <title>Aggie Points Check-In</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 40px; }
    #formContainer { display: none; margin-top: 20px; }
    iframe { width: 100%; height: 800px; border: none; }
  </style>
</head>
<body>
  <h2>Aggie Points Check-In</h2>
  <p id="status">Checking your location...</p>
  <div id="formContainer">
    <iframe id="jotformFrame"></iframe>
  </div>

  <script>
    const sheetUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKTWEbVoSyYdw6wVVbIuql9hb_NoAt7jcLoFfKI2PCz9UA3z8PJwkrWcFDjbEbGj9FVb_R_6r2Y2es/pub?output=csv";

    // --- Step 1: Check if redirected after submission ---
    const urlParams = new URLSearchParams(window.location.search);
    const submittedEvent = urlParams.get("submitted");
    if (submittedEvent) {
      localStorage.setItem("submitted_" + submittedEvent, "true");
      document.getElementById("status").innerText =
        `✅ You’ve already checked in for ${submittedEvent}`;
      // hide form permanently for this event
      document.getElementById("formContainer").style.display = "none";
    }

    // --- Step 2: Load event data from sheet ---
    async function getEventData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim());
      const now = new Date();

      return rows.slice(1).map(r => ({
        name: r[headers.indexOf("Event Name")],
        latMin: parseFloat(r[headers.indexOf("Lat Min")]),
        latMax: parseFloat(r[headers.indexOf("Lat Max")]),
        lngMin: parseFloat(r[headers.indexOf("Lng Min")]),
        lngMax: parseFloat(r[headers.indexOf("Lng Max")]),
        start: new Date(r[headers.indexOf("Start Time")]),
        end: new Date(r[headers.indexOf("End Time")])
      })).find(ev => now >= ev.start && now <= ev.end);
    }

    function inBox(lat, lng, ev) {
      return (
        lat >= ev.latMin &&
        lat <= ev.latMax &&
        lng >= ev.lngMin &&
        lng <= ev.lngMax
      );
    }

    // --- Step 3: GPS + Event check ---
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const event = await getEventData();

      if (!event) {
        document.getElementById("status").innerText = "❌ No event scheduled right now.";
        return;
      }

      // Prevent duplicate submissions
      if (localStorage.getItem("submitted_" + event.name)) {
        document.getElementById("status").innerText =
          `✅ You’ve already checked in for ${event.name}`;
        return;
      }

      if (inBox(lat, lng, event)) {
        document.getElementById("status").innerText =
          `Welcome! Checking you into ${event.name}`;
        const jotformUrl =
          `https://form.jotform.com/252508114551046?eventName=${encodeURIComponent(event.name)}&eventStart=${event.start.toISOString()}&eventEnd=${event.end.toISOString()}`;
        document.getElementById("jotformFrame").src = jotformUrl;
        document.getElementById("formContainer").style.display = "block";
      } else {
        document.getElementById("status").innerText =
          "❌ You are not at the correct location for this event.";
      }
    }, () => {
      document.getElementById("status").innerText =
        "Unable to get location. Please enable GPS.";
    });
  </script>
</body>
</html>
