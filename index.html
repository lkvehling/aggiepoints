<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aggie Points</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; text-align: center; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    .event { border: 1px solid #ccc; padding: 15px; margin: 10px; }
  </style>
</head>
<body>

  <h1>Aggie Points Check-In</h1>
  <p id="userInfo">Checking login...</p>
  <div id="eventsContainer">Loading events...</div>

  <script>
    const SUPABASE_URL = "https://gtnptxnkminqmjnnfxie.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0bnB0eG5rbWlucW1qbm5meGllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzA0NTEsImV4cCI6MjA3MjQ0NjQ1MX0.LkEbFzHkyBVjxEFgAm_KL30buEkkkoMPsBMUeNyRGow";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function main() {
      const { data: { user }, error } = await supabase.auth.getUser();

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      document.getElementById("userInfo").textContent = `Logged in as: ${user.email}`;

      const today = new Date().toISOString().split("T")[0];
      const { data: events, error: eventsError } = await supabase
        .from("events")
        .select("*")
        .gte("start_time", today + "T00:00:00")
        .lte("end_time", today + "T23:59:59");

      const container = document.getElementById("eventsContainer");
      container.innerHTML = "";

      if (!events || events.length === 0) {
        container.textContent = "No events scheduled today.";
        return;
      }

      events.forEach(ev => {
        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <h3>${ev.name}</h3>
          <p>Location: ${ev.location || "N/A"}</p>
          <p>Points: ${ev.points}</p>
          <button onclick="checkIn('${ev.id}')">Check In</button>
        `;
        container.appendChild(div);
      });
    }

    async function checkIn(eventId) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert("Not logged in.");

      const { error } = await supabase
        .from("checkins")
        .insert([{ user_id: user.id, event_id: eventId }]);

      if (error) {
        alert("❌ Already checked in or error: " + error.message);
        return;
      }

      alert("✅ You are checked in!");
      main(); // Refresh list or disable button if needed
    }

    main();
  </script>

</body>
</html>
