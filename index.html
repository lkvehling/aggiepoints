<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AggiePoints Check-in</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #status {
      margin: 20px 0;
      font-weight: bold;
    }
    #formContainer {
      display: none;
      margin-top: 20px;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1>AggiePoints Check-in</h1>
  <p id="status">Fetching event data...</p>

  <div id="formContainer">
    <iframe id="jotformFrame"></iframe>
  </div>

  <script>
    const CSV_URL = "events.csv"; // replace with your actual CSV path

    async function fetchCSV() {
      const response = await fetch(CSV_URL);
      const text = await response.text();
      return text.split("\n").map(row => row.split(","));
    }

    function parseEvent(row, headers) {
      return {
        name: row[0],
        latMin: parseFloat(row[1]),
        latMax: parseFloat(row[2]),
        lngMin: parseFloat(row[3]),
        lngMax: parseFloat(row[4]),
        start: new Date(row[5]),
        end: new Date(row[6])
      };
    }

    function markSubmitted(eventName) {
      localStorage.setItem("submitted_" + eventName, "true");
    }

    function alreadySubmitted(eventName) {
      return localStorage.getItem("submitted_" + eventName) === "true";
    }

    function loadForm(event) {
      const jotformUrl = `https://form.jotform.com/252508114551046?eventName=${encodeURIComponent(event.name)}`;
      const iframe = document.getElementById("jotformFrame");

      iframe.src = jotformUrl;
      document.getElementById("formContainer").style.display = "block";

      // Watch for the JotForm thank-you page
      iframe.onload = function () {
        try {
          if (iframe.contentWindow.location.href.includes("thankyou")) {
            markSubmitted(event.name);
            document.getElementById("status").innerText = `‚úÖ Successfully checked in for ${event.name}`;
          }
        } catch (e) {
          // fallback if cross-origin blocks
          if (iframe.src.includes("thankyou")) {
            markSubmitted(event.name);
            document.getElementById("status").innerText = `‚úÖ Successfully checked in for ${event.name}`;
          }
        }
      };
    }

    async function checkIn() {
      try {
        const rows = await fetchCSV();
        const headers = rows[0];
        const dataRows = rows.slice(1);

        const now = new Date();
        const eventRow = dataRows.find(row => {
          const event = parseEvent(row, headers);
          return now >= event.start && now <= event.end;
        });

        if (!eventRow) {
          document.getElementById("status").innerText = "‚ùå No scheduled event right now.";
          return;
        }

        const event = parseEvent(eventRow, headers);

        // Get GPS
        if (!navigator.geolocation) {
          document.getElementById("status").innerText = "‚ùå Geolocation not supported.";
          return;
        }

        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            const withinBounds =
              lat >= event.latMin &&
              lat <= event.latMax &&
              lng >= event.lngMin &&
              lng <= event.lngMax;

            if (!withinBounds) {
              document.getElementById("status").innerText =
                "‚ùå You are not at the correct event location.";
              return;
            }

            if (alreadySubmitted(event.name)) {
              document.getElementById("status").innerText =
                `‚úÖ Already checked in for ${event.name}.`;
              return;
            }

            document.getElementById("status").innerText =
              `üìç Correct location detected for ${event.name}. Please complete the form.`;

            loadForm(event);
          },
          () => {
            document.getElementById("status").innerText =
              "‚ùå Unable to get location. Please ensure GPS is enabled.";
          }
        );
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå Error fetching event data.";
      }
    }

    checkIn();
  </script>
</body>
</html>
