<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Events</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Today's Events</h1>
  <div id="events"></div>

  <script>
    // 🔑 Your Supabase credentials
    const SUPABASE_URL = "https://gtnptxnkminqmjnnfxie.supabase.co";
    const SUPABASE_KEY = "YOUR_ANON_KEY_HERE";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ✅ Load current user
    async function getUser() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        alert("You must log in first!");
        return null;
      }
      return user;
    }

    // ✅ Fetch today’s events
    async function loadEvents() {
      const today = new Date();
      const start = new Date(today.setHours(0,0,0,0)).toISOString();
      const end = new Date(today.setHours(23,59,59,999)).toISOString();

      const { data: events, error } = await supabase
        .from("events")
        .select("*")
        .gte("start_time", start)
        .lte("end_time", end);

      if (error) {
        console.error(error);
        return;
      }

      const container = document.getElementById("events");
      container.innerHTML = "";

      if (events.length === 0) {
        container.innerHTML = "<p>No events scheduled for today.</p>";
        return;
      }

      events.forEach(event => {
        const div = document.createElement("div");
        div.innerHTML = `
          <h3>${event.name}</h3>
          <p>${event.location}</p>
          <p>${new Date(event.start_time).toLocaleString()} - ${new Date(event.end_time).toLocaleString()}</p>
          <button onclick="checkIn('${event.id}')">Check In</button>
          <p id="msg-${event.id}" style="color: green;"></p>
        `;
        container.appendChild(div);
      });
    }

    // ✅ Handle check-in
    async function checkIn(eventId) {
      const user = await getUser();
      if (!user) return;

      const { error } = await supabase
        .from("checkins")
        .insert([{ user_id: user.id, event_id: eventId }]);

      const msg = document.getElementById(`msg-${eventId}`);

      if (error) {
        if (error.message.includes("duplicate")) {
          msg.textContent = "✅ Already checked in!";
        } else {
          msg.textContent = "❌ Error: " + error.message;
        }
      } else {
        msg.textContent = "🎉 Successfully checked in!";
      }
    }

    // Load events on page load
    loadEvents();
  </script>
</body>
</html>
